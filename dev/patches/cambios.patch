 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/dev/dev.html b/dev/dev.html
index 8aa67def8279a7038e616eddbe153326efd6b1f6..ffeca984df55e874683a9c2908c62fad65cb4423 100644
--- a/dev/dev.html
+++ b/dev/dev.html
@@ -397,50 +397,82 @@ body{
   border:2px solid #ff6b35;
   pointer-events:none;
   z-index:1000;
   box-shadow:0 4px 15px rgba(0,0,0,.5);
   display:none;
   max-width:320px;
   font-size:.85em;
 }
 .tooltip.active{display:block}
 .tooltip strong{
   color:#ff6b35;
   display:block;
   margin-bottom:4px;
   font-size:1em;
 }
 .tooltip .layer{
   color:#a8dadc;
   font-size:.8em;
   margin-bottom:4px;
 }
 .tooltip .description{
   color:#c0c0c0;
   font-size:.8em;
   line-height:1.3;
 }
+.modal-overlay{
+  position:fixed;
+  inset:0;
+  background:rgba(0,0,0,.6);
+  display:flex;
+  align-items:center;
+  justify-content:center;
+  z-index:1500;
+  padding:20px;
+}
+.modal-content{
+  background:#1e2a3a;
+  border:1px solid #2d3e50;
+  border-radius:10px;
+  padding:24px;
+  max-width:420px;
+  width:100%;
+  box-shadow:0 12px 30px rgba(0,0,0,.45);
+  text-align:center;
+}
+.modal-content h3{
+  margin-bottom:12px;
+  color:#a8dadc;
+}
+.modal-content p{
+  margin-bottom:16px;
+  color:#e0e0e0;
+}
+.modal-content .btn{
+  margin-top:4px;
+  width:100%;
+}
 
 .node-group{
   cursor:grab;
   transition:opacity .2s;
 }
 .node-group:active{cursor:grabbing}
 .node-body{stroke-width:2;}
 .node-label{
   font-size:11px;
   font-weight:600;
   fill:#e0e0e0;
 }
 .link-path{
   fill:none;
   stroke-width:2;
   opacity:.7;
   transition:opacity .2s,stroke-width .15s;
 }
 .link-data{stroke:#ff6b35;}
 .link-mgmt{stroke:#4ecca3;stroke-dasharray:6 4;}
 .link-span{stroke:#a8dadc;stroke-dasharray:3 3;}
 .link-api{stroke:#e63946;stroke-dasharray:4 4;}
 .dim-node{opacity:.18;}
 .dim-link{opacity:.18;}
 .highlight-node{
@@ -699,137 +731,175 @@ body{
       <h2>Diagrama de la arquitectura de la maqueta</h2>
       <p>Pasa el cursor sobre los componentes o líneas para ver detalles. Los componentes conectados se resaltan automáticamente.</p>
       <div id="diagram-container"></div>
     </div>
 
   </div>
 
   <!-- BOTÓN ENVIAR + FALLBACK -->
   <div class="footer-actions">
     <div class="footer-actions-inner">
       <button type="button" class="btn btn-primary" onclick="handleSubmit()">Enviar</button>
 
       <div id="fallback" style="display:none" class="fallback-section">
         <h3>El enlace mailto es muy largo. Copia el contenido:</h3>
         <p style="margin-bottom:10px;color:#a8dadc;"><strong>Para:</strong> <span id="fallback-to"></span></p>
         <p style="margin-bottom:10px;color:#a8dadc;"><strong>Asunto:</strong> <span id="fallback-subject"></span></p>
         <textarea id="fallback-body" readonly></textarea>
         <button type="button" class="btn btn-primary" style="margin-top:10px;" onclick="copyToClipboard()">Copiar al portapapeles</button>
       </div>
     </div>
   </div>
 
 </div>
 
 <div id="tooltip" class="tooltip"></div>
+<div id="successModal" class="modal-overlay" style="display:none;">
+  <div class="modal-content">
+    <h3>Solicitud enviada</h3>
+    <p>Tu solicitud fue enviada. Revisa tu correo para la confirmación dentro de las próximas 24 horas.</p>
+    <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">Cerrar</button>
+  </div>
+</div>
 
 <script>
 const mailtoRecipient = 'showroom-itot@ejemplo.com';
 
 // --- NUEVO: lógica de calendario y horarios con lectura de CSV ---
 const DISPLAY_HOURS = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
 const RESERVABLE_HOURS = ['10:00','11:00','12:00','13:00','14:00','15:00','16:00'];
 let selectedDate = null;      // 'YYYY-MM-DD'
 let selectedTime = null;      // 'HH:MM'
 let reservationsByDate = {};  // { 'YYYY-MM-DD': ['11:00', '14:00'] }
 let availabilityByDate = {};
 let currentMonthDate = new Date();
+let cachedCsvRows = null;     // Matriz con los datos de reservas.csv (incluye encabezados)
+const CSV_HEADERS = ['Fecha','HoraInicio','HoraFin','Estado','Empresa','Sector','NumeroInvitados','Comentarios','RequiereEquipoLab','InvitadosJson','Tecnologias'];
 
 async function reservasdb(){
   try{
+    let cachedText = null;
+    if(typeof localStorage !== 'undefined'){
+      try{
+        cachedText = localStorage.getItem('reservasCsvCache');
+      }catch(err){
+        console.warn('No se pudo leer la caché local de reservas.csv', err);
+      }
+    }
+    if(cachedText){
+      const cachedRows = parseCsv(cachedText);
+      if(cachedRows.length>0){
+        cachedCsvRows = cachedRows;
+        return csvRowsToReservations(cachedRows);
+      }
+    }
+
     const response = await fetch('../data/reservas.csv');
     if(!response.ok) throw new Error('No se pudo leer reservas.csv');
     const csvText = await response.text();
     const rows = parseCsv(csvText);
+    cachedCsvRows = rows;
+    if(typeof localStorage !== 'undefined'){
+      try{
+        localStorage.setItem('reservasCsvCache', csvText);
+      }catch(err){
+        console.warn('No se pudo guardar el CSV en localStorage', err);
+      }
+    }
     if(rows.length === 0) return [];
 
-    const headers = rows[0].map(h=>h.trim());
-    return rows.slice(1).map(values=>{
-      const record = {};
-      headers.forEach((h,idx)=>{record[h]=values[idx]?.trim()||'';});
-      const techList = (record.Tecnologias || record.Soluciones || '').split(';').map(t=>t.trim()).filter(Boolean);
-
-      return {
-        fecha: record.Fecha || record.fecha || record.date || '',
-        horaInicio: record.HoraInicio || record.Hora || record.hora || '',
-        horaFin: record.HoraFin || record.horafin || '',
-        estado: record.Estado || record.estado || '',
-        empresa: record.Empresa || record.empresa || '',
-        sector: record.Sector || record.sector || '',
-        numeroInvitados: record.NumeroInvitados || record.invitados || '',
-        comentarios: record.Comentarios || record.comentarios || '',
-        requiereEquipoLab: record.RequiereEquipoLab === true || record.RequiereEquipoLab === 'true' || record.RequiereEquipoLab === '1',
-        invitadosDetalle: record.InvitadosJson || record.Invitados || '',
-        tecnologias: techList
-      };
-    });
+    return csvRowsToReservations(rows);
   }catch(err){
     console.error('No se pudieron leer las reservas desde el CSV', err);
     return [];
   }
 }
 
 // Parser simple para CSV con comillas y comas embebidas
 function parseCsv(text){
   const rows = [];
   let row = [];
   let field = '';
   let inQuotes = false;
 
   for(let i=0; i<text.length; i++){
     const char = text[i];
     if(char === '"'){
       const next = text[i+1];
       if(inQuotes && next === '"'){
         field += '"';
         i++;
       }else{
         inQuotes = !inQuotes;
       }
     }else if(char === ',' && !inQuotes){
       row.push(field);
       field = '';
     }else if((char === '\n' || char === '\r') && !inQuotes){
       if(field.length>0 || row.length>0){
         row.push(field);
         rows.push(row);
         row = [];
         field = '';
       }
     }else{
       field += char;
     }
   }
 
   if(field.length>0 || row.length>0){
     row.push(field);
     rows.push(row);
   }
 
   return rows.filter(r=>r.some(v=>v.trim().length>0));
 }
 
+function csvRowsToReservations(rows){
+  if(!rows || rows.length === 0) return [];
+  const headers = rows[0].map(h=>h.trim());
+  return rows.slice(1).map(values=>{
+    const record = {};
+    headers.forEach((h,idx)=>{record[h]=values[idx]?.trim()||'';});
+    const techList = (record.Tecnologias || record.Soluciones || '').split(';').map(t=>t.trim()).filter(Boolean);
+
+    return {
+      fecha: record.Fecha || record.fecha || record.date || '',
+      horaInicio: record.HoraInicio || record.Hora || record.hora || '',
+      horaFin: record.HoraFin || record.horafin || '',
+      estado: record.Estado || record.estado || '',
+      empresa: record.Empresa || record.empresa || '',
+      sector: record.Sector || record.sector || '',
+      numeroInvitados: record.NumeroInvitados || record.invitados || '',
+      comentarios: record.Comentarios || record.comentarios || '',
+      requiereEquipoLab: record.RequiereEquipoLab === true || record.RequiereEquipoLab === 'true' || record.RequiereEquipoLab === '1',
+      invitadosDetalle: record.InvitadosJson || record.Invitados || '',
+      tecnologias: techList
+    };
+  });
+}
+
 function normalizeTimeSlot(timeStr){
   if(!timeStr) return null;
   const parts = timeStr.toString().trim().split(':');
   const hour = parts[0];
   if(hour === undefined) return null;
   const hourNum = Number(hour);
   if(Number.isNaN(hourNum)) return null;
   return `${String(hourNum).padStart(2,'0')}:00`;
 }
 
 function addBlockedSlot(blockedSet,timeStr){
   const normalized = normalizeTimeSlot(timeStr);
   if(!normalized) return;
   const hour = parseInt(normalized.split(':')[0],10);
   if(Number.isNaN(hour)) return;
   [hour-1,hour,hour+1].forEach(h=>{
     const slot = `${String(h).padStart(2,'0')}:00`;
     if(DISPLAY_HOURS.includes(slot)){
       blockedSet.add(slot);
     }
   });
 }
 
 function buildAvailabilityMap(){
   availabilityByDate = {};
@@ -1231,51 +1301,50 @@ function getSelectedSolutions(){
   function pick(id,name,group){
     if(document.getElementById(id).checked){
       let brandText = null;
       if(group){
         const r = document.querySelector('input[name="'+group+'"]:checked');
         brandText = r ? r.value : null;
       }
       solutions.push({name,brand:brandText || 'Sin marca seleccionada'});
     }
   }
   pick('sol-fw-ot','FW OT','fw-ot-brand');
   pick('sol-visibility','Visibilidad de Red OT','visibility-brand');
   pick('sol-vuln','Gestión de vulnerabilidades OT','vuln-brand');
   pick('sol-ips','IPS','ips-brand');
   pick('sol-access','Acceso Seguro / ZTNA','access-brand');
   pick('sol-deception','Deception OT','deception-brand');
   pick('sol-soc','SOC','soc-brand');
   return solutions;
 }
 
 function buildMailto(){
   if(!validateForm()){
     alert('Por favor complete todos los campos obligatorios, seleccione al menos una solución y una marca para cada solución seleccionada.');
     return null;
   }
-  const date = document.getElementById('requestedDate').value;
   const comments = document.getElementById('comments').value.trim();
   const companyName = document.getElementById('companyName').value.trim();
   const guestCount = document.getElementById('guestCount').value.trim();
   const sector = document.getElementById('sector').value.trim();
   const requiresLabTeam = document.getElementById('labTeamPresent').checked;
   const solutions = getSelectedSolutions();
   const dateStrIso = (selectedDate && selectedTime) ? `${selectedDate}T${selectedTime}:00` : null;
   const dateObj = dateStrIso ? new Date(dateStrIso) : null;
   const dateStr = dateObj ? dateObj.toLocaleString('es-ES',{
     year:'numeric',month:'2-digit',day:'2-digit',
     hour:'2-digit',minute:'2-digit'
   }) : '';
 
  const subject = `Solicitud Showroom IT/OT - ${dateStr} - ${companyName || "Empresa no indicada"}`;
  let body  = `Estimado equipo de Showroom IT/OT,\n\n`;
   body += `Solicito la reserva del showroom con los siguientes detalles:\n\n`;
   
   body += `DATOS DEL CLIENTE\n`;
   body += `-----------------\n`;
     if(companyName) body += `Empresa: ${companyName}\n`;
   if(sector) body += `Sector: ${sector}\n`;
   if(guestCount) body += `Número de invitados: ${guestCount}\n`;
   body += `Fecha solicitada: ${dateStr}\n\n`;
 
   if(guests.length>0){
@@ -1305,80 +1374,197 @@ function buildMailto(){
     body += `\nREQUERIMIENTOS ADICIONALES\n`;
     body += `------------------------\n`;
     body += `• El cliente solicita que la presentación sea impartida por el equipo de laboratorio.\n`;
   }
 
   body += `\nSaludos cordiales`;
 
   return {to:mailtoRecipient,subject,body};
 }
 
 function openOutlook(){
   const mailData = buildMailto();
   if(!mailData) return;
   const mailtoLink = `mailto:${encodeURIComponent(mailData.to)}?subject=${encodeURIComponent(mailData.subject)}&body=${encodeURIComponent(mailData.body)}`;
   if(mailtoLink.length>1900){
     document.getElementById('fallback-to').textContent = mailData.to;
     document.getElementById('fallback-subject').textContent = mailData.subject;
     document.getElementById('fallback-body').value = mailData.body;
     document.getElementById('fallback').style.display='block';
   }else{
     document.getElementById('fallback').style.display='none';
     window.location.href = mailtoLink;
   }
 }
 
+function addOneHour(timeStr){
+  if(!timeStr) return '';
+  const [hourStr, minuteStr='00'] = timeStr.split(':');
+  const hourNum = Number(hourStr);
+  if(Number.isNaN(hourNum)) return '';
+  const nextHour = Math.min(hourNum + 1, 23);
+  return `${String(nextHour).padStart(2,'0')}:${minuteStr.padStart(2,'0')}`;
+}
+
 function buildReservationRecord(){
   const companyName = document.getElementById('companyName').value.trim();
   const sector = document.getElementById('sector').value.trim();
   const guestCount = document.getElementById('guestCount').value.trim();
   const comments = document.getElementById('comments').value.trim();
   const requiresLabTeam = document.getElementById('labTeamPresent').checked;
   const solutions = getSelectedSolutions();
+  const horaInicio = selectedTime;
+  const horaFin = addOneHour(selectedTime);
 
   return {
     fecha: selectedDate,
-    hora: selectedTime,
+    hora: horaInicio,
+    horaInicio,
+    horaFin,
+    estado: 'pendiente',
     empresa: companyName,
     sector,
     numeroInvitados: guestCount,
     comentarios: comments,
     requiereEquipoLab: requiresLabTeam,
     invitados: [...guests],
     tecnologias: solutions.map(s=>`${s.name} (${s.brand})`)
   };
 }
 
- async function handleSubmit(){
+function escapeCsvField(value){
+  const str = (value ?? '').toString();
+  if(/[",\n]/.test(str)){
+    return '"' + str.replace(/"/g,'""') + '"';
+  }
+  return str;
+}
+
+function reservationToCsvRow(record){
+  const invitadoJson = JSON.stringify(record.invitados || []);
+  const tecnologiasList = Array.isArray(record.tecnologias) ? record.tecnologias.join(';') : (record.tecnologias || '');
+  return [
+    record.fecha || '',
+    record.horaInicio || record.hora || '',
+    record.horaFin || '',
+    record.estado || 'pendiente',
+    record.empresa || '',
+    record.sector || '',
+    record.numeroInvitados || '',
+    record.comentarios || '',
+    record.requiereEquipoLab ? '1' : '0',
+    invitadoJson,
+    tecnologiasList
+  ];
+}
+
+function serializeCsv(rows){
+  return rows.map(r=>r.map(escapeCsvField).join(',')).join('\n');
+}
+
+async function appendReservationToCsv(record){
+  const csvUrl = '../data/reservas.csv';
+  let rows = cachedCsvRows && cachedCsvRows.length ? cachedCsvRows.map(r=>[...r]) : null;
+
+  if(!rows){
+    try{
+      const response = await fetch(csvUrl);
+      if(response.ok){
+        const text = await response.text();
+        const parsed = parseCsv(text);
+        if(parsed.length>0){
+          rows = parsed;
+        }
+      }
+    }catch(err){
+      console.warn('No se pudo leer reservas.csv; se iniciará uno nuevo en memoria.', err);
+    }
+  }
+
+  if(!rows || rows.length === 0){
+    rows = [CSV_HEADERS];
+  }else{
+    const hasHeader = CSV_HEADERS.every((h,idx)=> (rows[0][idx] || '').trim().toLowerCase() === h.toLowerCase());
+    if(!hasHeader){
+      rows = [CSV_HEADERS, ...rows];
+    }
+  }
+
+  rows.push(reservationToCsvRow(record));
+  cachedCsvRows = rows;
+  const csvContent = serializeCsv(rows);
+  if(typeof localStorage !== 'undefined'){
+    try{
+      localStorage.setItem('reservasCsvCache', csvContent);
+    }catch(err){
+      console.warn('No se pudo guardar el CSV en localStorage', err);
+    }
+  }
+  console.log('reservas.csv actualizado en memoria:', csvContent);
+}
+
+function addReservationToState(record){
+  const dateStr = record.fecha;
+  const timeStr = normalizeTimeSlot(record.hora || record.horaInicio || record.horaFin);
+  if(!dateStr || !timeStr) return;
+  if(!reservationsByDate[dateStr]) reservationsByDate[dateStr] = [];
+  reservationsByDate[dateStr].push(timeStr);
+  buildAvailabilityMap();
+  renderCalendar(currentMonthDate);
+  if(selectedDate === dateStr){
+    renderTimeOptionsForSelectedDay();
+  }
+}
+
+function showSuccessModal(){
+  const modal = document.getElementById('successModal');
+  if(modal) modal.style.display = 'flex';
+}
+
+function closeSuccessModal(){
+  const modal = document.getElementById('successModal');
+  if(modal) modal.style.display = 'none';
+}
+
+async function handleSubmit(){
   if(!validateForm()){
     alert('Por favor selecciona una fecha, horario y al menos una solución con su marca.');
     return;
   }
 
+  const reservationData = buildReservationRecord();
   openOutlook();
 
-  const reservationData = buildReservationRecord();
+  try{
+    await appendReservationToCsv(reservationData);
+    addReservationToState(reservationData);
+  }catch(err){
+    console.error('No se pudo actualizar el CSV local', err);
+    alert('No se pudo actualizar el CSV localmente. Revisa la consola para más detalles.');
+  }
+
+  showSuccessModal();
   console.log('Datos listos para almacenar en reservasdb:', reservationData);
 }
 
 function copyToClipboard(){
   const textarea = document.getElementById('fallback-body');
   const to = document.getElementById('fallback-to').textContent;
   const subject = document.getElementById('fallback-subject').textContent;
   const fullText = `Para: ${to}\n\nAsunto: ${subject}\n\n${textarea.value}`;
   navigator.clipboard.writeText(fullText).then(()=>{
     alert('Contenido copiado al portapapeles');
   }).catch(()=>{
     textarea.select();
     document.execCommand('copy');
     alert('Contenido copiado al portapapeles');
   });
 }
 
 /* Purdue helpers */
 function getLayerInfo(level){
   return purdueLayers.find(l=>l.level===level);
 }
 function getLayerCenterY(level){
   const layer = getLayerInfo(level);
   return layer ? layer.y + layer.height/2 : 0;
 }
 
EOF
)