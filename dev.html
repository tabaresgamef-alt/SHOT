<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Showroom IT/OT - SHOTv17</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
  color:#e0e0e0;
  min-height:100vh;
  padding:20px;
}
.container{
  max-width:1800px;
  margin:0 auto;
  display:grid;
  grid-template-columns:450px 1fr;
  gap:30px;
  align-items:start;
}
.header{
  grid-column:1 / -1;
  text-align:center;
  margin-bottom:20px;
  padding:20px;
  background:linear-gradient(135deg,#0f3460 0%,#16213e 100%);
  border-radius:10px;
  box-shadow:0 4px 15px rgba(0,0,0,.3);
}
.header h1{
  color:#ff6b35;
  font-size:2.5em;
  text-shadow:2px 2px 4px rgba(0,0,0,.5);
}
.form-panel{
  background:linear-gradient(135deg,#1e2a3a 0%,#243447 100%);
  padding:30px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  border:1px solid #2d3e50;
}
.form-group{margin-bottom:20px}
.form-group label{
  display:block;
  margin-bottom:8px;
  color:#a8dadc;
  font-weight:600;
  font-size:.95em;
}
.form-group input,
.form-group textarea{
  width:100%;
  padding:12px;
  border:2px solid #2d3e50;
  border-radius:6px;
  background:#1a2332;
  color:#e0e0e0;
  font-size:1em;
  transition:all .3s;
}
.form-group input:focus,
.form-group textarea:focus{
  outline:none;
  border-color:#ff6b35;
  box-shadow:0 0 10px rgba(255,107,53,.3);
}
.form-group textarea{
  resize:vertical;
  min-height:80px;
}
.guest-form{
  display:flex;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.guest-form input{
  flex:1;
  min-width:140px;
}
.btn-guest-add{
  padding:10px 16px;
  border:none;
  border-radius:6px;
  background:#457b9d;
  color:#fff;
  font-size:.85em;
  font-weight:600;
  cursor:pointer;
  transition:all .3s;
  white-space:nowrap;
}
.btn-guest-add:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,.3);
}
#guestList{
  margin-top:5px;
}
.guest-list-item{
  font-size:.85em;
  color:#cfd8dc;
  margin-bottom:4px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.guest-text{
  flex:1;
}
.guest-actions{
  display:flex;
  gap:6px;
}
.guest-btn{
  padding:3px 8px;
  border:none;
  border-radius:4px;
  font-size:.75em;
  cursor:pointer;
}
.guest-btn.edit{
  background:#457b9d;
  color:#fff;
}
.guest-btn.delete{
  background:#e63946;
  color:#fff;
}

.solution-section{margin-top:25px}
.solution-item{
  margin-bottom:20px;
  padding:15px;
  background:#1a2332;
  border-radius:8px;
  border-left:4px solid #ff6b35;
}
.solution-checkbox{
  display:flex;
  align-items:center;
  margin-bottom:10px;
}
.solution-checkbox input[type="checkbox"]{
  width:20px;
  height:20px;
  margin-right:10px;
  cursor:pointer;
}
.solution-checkbox label{
  cursor:pointer;
  font-weight:600;
  color:#ff6b35;
  font-size:1.05em;
}
.brands-group{
  margin-left:30px;
  margin-top:10px;
  display:none;
}
.brands-group.active{display:block}
.brand-option{
  display:flex;
  align-items:center;
  margin-bottom:6px;
}
.brand-option input[type="radio"]{
  width:18px;
  height:18px;
  margin-right:8px;
  cursor:pointer;
}
.brand-option label{
  cursor:pointer;
  color:#a8dadc;
  font-size:.9em;
}
.buttons-group{
  margin-top:30px;
  display:flex;
  gap:15px;
}
.btn{
  flex:1;
  padding:15px 25px;
  border:none;
  border-radius:8px;
  font-size:1em;
  font-weight:600;
  cursor:pointer;
  transition:all .3s;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
.btn-primary{
  background:linear-gradient(135deg,#ff6b35 0%,#e85d2a 100%);
  color:#fff;
}
.btn-secondary{
  background:linear-gradient(135deg,#457b9d 0%,#1d3557 100%);
  color:#fff;
}
.btn:disabled{
  opacity:.5;
  cursor:not-allowed;
}

.fallback-section{
  margin-top:20px;
  padding:20px;
  background:#1a2332;
  border-radius:8px;
  border:2px solid #ff6b35;
}
.fallback-section h3{
  color:#ff6b35;
}
.fallback-section textarea{
  width:100%;
  min-height:200px;
  padding:12px;
  background:#0f1923;
  color:#e0e0e0;
  border:1px solid #2d3e50;
  border-radius:6px;
  font-family:monospace;
}

.diagram-panel{
  background:linear-gradient(135deg,#1e2a3a 0%,#243447 100%);
  padding:25px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  border:1px solid #2d3e50;
  min-height:1020px;
}
.diagram-panel h2{
  color:#ff6b35;
}
#diagram-container{
  width:100%;
  height:980px;
  background:#0f1923;
  border-radius:8px;
  position:relative;
  overflow:hidden;
}

.tooltip{
  position:fixed;
  background:rgba(30,42,58,.95);
  color:#e0e0e0;
  padding:10px 14px;
  border-radius:8px;
  border:2px solid #ff6b35;
  pointer-events:none;
  z-index:1000;
  display:none;
  max-width:320px;
  font-size:.85em;
}
.tooltip.active{display:block}
.tooltip strong{
  color:#ff6b35;
  margin-bottom:4px;
  display:block;
}
.dim-node{opacity:.18}
.highlight-node{
  opacity:1;
  filter:drop-shadow(0 0 6px rgba(255,255,255,.5));
}
.dim-link{opacity:.18}
.highlight-link{
  opacity:1;
  stroke-width:3;
}

.layer-rect{
  stroke:#2d3e50;
  stroke-width:1;
}
.layer-label{
  font-size:11px;
  fill:#a8dadc;
  font-weight:600;
}
.node-label{
  fill:#e0e0e0;
  font-size:11px;
  font-weight:600;
  text-anchor:middle;
}
.link-path{
  fill:none;
  stroke-width:2;
  opacity:.7;
  transition:opacity .2s,stroke-width .15s;
}
.link-data{stroke:#ff6b35;}
.link-mgmt{stroke:#4ecca3;stroke-dasharray:6 4;}
.link-span{stroke:#a8dadc;stroke-dasharray:3 3;}
.link-api{stroke:#e63946;stroke-dasharray:4 4;}
</style>
</head>
<body>

<!-- PASO 1 -->
<div id="step1-wrapper" class="container">
  <div class="header"><h1>üè≠ Showroom IT/OT</h1></div>

  <div class="form-panel">
    <h2>Paso 1 ‚Äì Datos del Ejecutivo</h2>

    <div class="form-group">
      <label>Nombre del Ejecutivo *</label>
      <input type="text" id="executiveName">
    </div>

    <div class="form-group">
      <label>Correo Corporativo *</label>
      <input type="email" id="email">
    </div>

    <div class="form-group">
      <label>Nombre del cliente *</label>
      <input type="text" id="clientName">
    </div>

    <div class="form-group">
      <label>Fecha solicitada *</label>
      <input type="datetime-local" id="requestedDate">
    </div>

    <div class="form-group">
      <label>Comentarios</label>
      <textarea id="comments"></textarea>
    </div>

    <div class="form-group">
      <label>Empresa</label>
      <input type="text" id="companyName">
    </div>

    <div class="form-group">
      <label>Cantidad de invitados</label>
      <input type="number" id="guestCount">
    </div>

    <div class="form-group">
      <label>Invitados</label>
      <div class="guest-form">
        <input id="guestNameInput" placeholder="Nombre">
        <input id="guestRoleInput" placeholder="Puesto">
        <button class="btn-guest-add" onclick="addGuest()">Agregar</button>
      </div>
      <div id="guestList"></div>
    </div>

    <div class="form-group">
      <label>Sector</label>
      <input type="text" id="sector">
    </div>

    <div class="form-group">
      <label><input type="checkbox" id="labTeamPresent"> Requieren que presente el equipo de laboratorio</label>
    </div>

    <div class="buttons-group">
      <button class="btn btn-primary" onclick="goToStep2()">Siguiente</button>
    </div>
  </div>

  <div class="diagram-panel">
    <h2>Bienvenido al Showroom IT/OT</h2>
    <p>Captura los datos del cliente para continuar.</p>
  </div>
</div>

<!-- PASO 2 -->
<div id="step2-wrapper" class="container" style="display:none">
  <div class="header"><h1>üè≠ Showroom IT/OT</h1></div>

  <div class="form-panel">
    <h2>Paso 2 ‚Äì Selecci√≥n de Tecnolog√≠as</h2>

    <form id="reservationForm">

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-fw-ot" onchange="toggleBrands('fw-ot')">
          <label>FW OT</label>
        </div>
        <div class="brands-group" id="brands-fw-ot">
          <div class="brand-option"><input type="radio" name="fw-ot-brand" value="Fortinet"><label>Fortinet</label></div>
          <div class="brand-option"><input type="radio" name="fw-ot-brand" value="Check Point"><label>Check Point</label></div>
          <div class="brand-option"><input type="radio" name="fw-ot-brand" value="TXOne"><label>TXOne</label></div>
          <div class="brand-option"><input type="radio" name="fw-ot-brand" value="Palo Alto Networks"><label>Palo Alto Networks</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-visibility" onchange="toggleBrands('visibility')">
          <label>Visibilidad OT</label>
        </div>
        <div class="brands-group" id="brands-visibility">
          <div class="brand-option"><input type="radio" name="visibility-brand" value="Nozomi"><label>Nozomi</label></div>
          <div class="brand-option"><input type="radio" name="visibility-brand" value="Tenable OT"><label>Tenable OT</label></div>
          <div class="brand-option"><input type="radio" name="visibility-brand" value="Claroty"><label>Claroty</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-vuln" onchange="toggleBrands('vuln')">
          <label>Vulnerabilidades OT</label>
        </div>
        <div class="brands-group" id="brands-vuln">
          <div class="brand-option"><input type="radio" name="vuln-brand" value="Nozomi"><label>Nozomi</label></div>
          <div class="brand-option"><input type="radio" name="vuln-brand" value="Tenable OT"><label>Tenable OT</label></div>
          <div class="brand-option"><input type="radio" name="vuln-brand" value="Claroty"><label>Claroty</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-ips" onchange="toggleBrands('ips')">
          <label>IPS</label>
        </div>
        <div class="brands-group" id="brands-ips">
          <div class="brand-option"><input type="radio" name="ips-brand" value="TXOne"><label>TXOne</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-access" onchange="toggleBrands('access')">
          <label>Acceso Seguro / ZTNA</label>
        </div>
        <div class="brands-group" id="brands-access">
          <div class="brand-option"><input type="radio" name="access-brand" value="Cyolo"><label>Cyolo</label></div>
          <div class="brand-option"><input type="radio" name="access-brand" value="Claroty"><label>Claroty</label></div>
          <div class="brand-option"><input type="radio" name="access-brand" value="Fortinet"><label>Fortinet</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-deception" onchange="toggleBrands('deception')">
          <label>Deception OT</label>
        </div>
        <div class="brands-group" id="brands-deception">
          <div class="brand-option"><input type="radio" name="deception-brand" value="Fortinet"><label>Fortinet</label></div>
          <div class="brand-option"><input type="radio" name="deception-brand" value="Zscaler"><label>Zscaler</label></div>
        </div>
      </div>

      <div class="solution-item">
        <div class="solution-checkbox">
          <input type="checkbox" id="sol-soc" onchange="toggleBrands('soc')">
          <label>SOC / SIEM</label>
        </div>
        <div class="brands-group" id="brands-soc">
          <div class="brand-option"><input type="radio" name="soc-brand" value="Splunk"><label>Splunk</label></div>
        </div>
      </div>

      <div class="buttons-group">
        <button type="button" class="btn btn-primary" onclick="openOutlook()">Abrir en Outlook</button>
      </div>

      <div id="fallback" style="display:none" class="fallback-section">
        <h3>El enlace es muy largo</h3>
        <p><strong>Para:</strong> <span id="fallback-to"></span></p>
        <p><strong>Asunto:</strong> <span id="fallback-subject"></span></p>
        <textarea id="fallback-body"></textarea>
        <button class="btn btn-primary" onclick="copyToClipboard()">Copiar</button>
      </div>

    </form>
  </div>

  <div class="diagram-panel">
    <h2>Diagrama IT/OT</h2>
    <div id="diagram-container"></div>
  </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
// ==== CONFIGURACIONES B√ÅSICAS =================================================
const mailtoRecipient = "showroom-itot@ejemplo.com";
const guests = [];
let currentNodes = {};
let currentLinks = [];
let adjacency = {};
let currentSvg = null;

// ==== ROBUST BRAND DETECTION ==================================================
function getSelectedBrand(name) {
  const r = document.querySelector(`input[name="${name}"]:checked`);
  if (!r) return null;
  const v = r.value.toLowerCase();
  const map = {
    fortinet:"fortinet", check:"checkpoint", point:"checkpoint",
    txone:"txone", palo:"paloalto", alto:"paloalto",
    nozomi:"nozomi", tenable:"tenable", claroty:"claroty",
    cyolo:"cyolo", zscaler:"zscaler", splunk:"splunk"
  };
  for (const k in map) if (v.includes(k)) return map[k];
  return null;
}

// ==== GUEST MANAGEMENT ========================================================
function addGuest() {
  const name = document.getElementById("guestNameInput").value.trim();
  const role = document.getElementById("guestRoleInput").value.trim();
  if (!name && !role) return;
  guests.push({name, role});
  document.getElementById("guestNameInput").value = "";
  document.getElementById("guestRoleInput").value = "";
  renderGuests();
}
function renderGuests() {
  const c = document.getElementById("guestList");
  if (guests.length === 0) {
    c.innerHTML = "<span style='font-size:0.8em;color:#718096;'>Sin invitados a√∫n.</span>";
    return;
  }
  c.innerHTML = guests.map((g,i)=>`
    <div class='guest-list-item'>
      <span>${i+1}. ${g.name} ‚Äì ${g.role}</span>
      <div>
        <button class='guest-btn delete' onclick='guests.splice(${i},1);renderGuests();'>Eliminar</button>
      </div>
    </div>
  `).join("");
}

// ==== WIZARD ================================================================
function validateStep1() {
  if (
    !document.getElementById("executiveName").value.trim() ||
    !document.getElementById("email").value.trim() ||
    !document.getElementById("clientName").value.trim() ||
    !document.getElementById("requestedDate").value
  ) {
    alert("Complete todos los campos obligatorios");
    return false;
  }
  return true;
}
function goToStep2() {
  if (!validateStep1()) return;
  document.getElementById("step1-wrapper").style.display="none";
  document.getElementById("step2-wrapper").style.display="grid";
  updateDiagram();
}

// ==== TOGGLE BRANDS =========================================================
function toggleBrands(id) {
  const chk = document.getElementById("sol-"+id);
  const grp = document.getElementById("brands-"+id);
  if (!grp) return;
  grp.classList.toggle("active", chk.checked);
  if (!chk.checked) {
    grp.querySelectorAll("input[type=radio]").forEach(r=>r.checked=false);
  }
  updateDiagram();
}

// ==== MAILTO ================================================================
function buildMailto() {
  const name = document.getElementById("executiveName").value.trim();
  const email = document.getElementById("email").value.trim();
  const client = document.getElementById("clientName").value.trim();
  const date = document.getElementById("requestedDate").value;
  const comments = document.getElementById("comments").value.trim();
  if (!name || !email || !client || !date) return null;

  const d = new Date(date).toLocaleString("es-ES",{hour12:false});
  const subject = `Solicitud Showroom - ${d} - ${name}`;
  let body = `Datos del Ejecutivo:\nNombre: ${name}\nCorreo: ${email}\n\n`;
  body += `Cliente: ${client}\nFecha: ${d}\n\n`;

  if (guests.length){
    body += `Invitados:\n`;
    guests.forEach((g,i)=>body+=`${i+1}. ${g.name} - ${g.role}\n`);
    body+="\n";
  }

  if (comments) body+=`Comentarios:\n${comments}\n\n`;

  return {to:mailtoRecipient,subject,body};
}
function openOutlook() {
  const m = buildMailto();
  if (!m) { alert("Faltan datos"); return; }
  const link = `mailto:${m.to}?subject=${encodeURIComponent(m.subject)}&body=${encodeURIComponent(m.body)}`;
  if (link.length>1800) {
    document.getElementById("fallback").style.display="block";
    document.getElementById("fallback-to").textContent=m.to;
    document.getElementById("fallback-subject").textContent=m.subject;
    document.getElementById("fallback-body").value=m.body;
  } else {
    location.href=link;
  }
}
function copyToClipboard(){
  const b=document.getElementById("fallback-body");
  navigator.clipboard.writeText(b.value);
  alert("Copiado");
}

// ==== DIAGRAMA ‚Äî CONSTANTES =================================================
const LAYER_HEIGHT = 130;
const purdueLayers = [
  {level:5,label:"",height:LAYER_HEIGHT*1.3},
  {level:4,label:"Nivel 4 ‚Äì Enterprise"},
  {level:3.5,label:"Nivel 3.5 ‚Äì DMZ IT/OT"},
  {level:3,label:"Nivel 3 ‚Äì Site Ops"},
  {level:2,label:"Nivel 2 ‚Äì Supervisi√≥n"},
  {level:1,label:"Nivel 1 ‚Äì Control"},
  {level:0,label:"Nivel 0 ‚Äì Proceso F√≠sico"}
];
let y=0; purdueLayers.forEach(l=>{l.y=y;y+=l.height||LAYER_HEIGHT;});

// ==== HELPERS ================================================================
function getLayerY(level){return purdueLayers.find(l=>l.level===level).y+(purdueLayers.find(l=>l.level===level).height/2);}
function createSvg(w,h){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width",w);s.setAttribute("height",h);return s;}

// ==== DIBUJAR CAPAS =========================================================
function drawLayers(svg,w){
  purdueLayers.forEach(l=>{
    const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r.setAttribute("x",0);
    r.setAttribute("y",l.y);
    r.setAttribute("width",w);
    r.setAttribute("height",l.height);
    r.setAttribute("class","layer-rect");
    svg.appendChild(r);
    if(l.label){
      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",10);
      t.setAttribute("y",l.y+18);
      t.setAttribute("class","layer-label");
      t.textContent=l.label;
      svg.appendChild(t);
    }
  });
}

// ==== NODES BASE ============================================================
function addNode(nodes,id,name,layer,x,type,desc,brand){
  nodes[id]={id,name,layer,x,y:getLayerY(layer),type,desc,brand};
}
function addLink(links,a,b,kind){
  links.push({from:a,to:b,kind});
}
function buildLinkPath(a,b){
  const A=currentNodes[a],B=currentNodes[b];
  const mid=(A.y+B.y)/2;
  return `M ${A.x} ${A.y} L ${A.x} ${mid} L ${B.x} ${mid} L ${B.x} ${B.y}`;
}

// ==== ADJACENCIA ============================================================
function buildAdjacency(){
  adjacency={};
  Object.keys(currentNodes).forEach(n=>adjacency[n]=new Set());
  currentLinks.forEach(l=>{
    adjacency[l.from].add(l.to);
    adjacency[l.to].add(l.from);
  });
}

// ==== TOOLTIP ===============================================================
function showNodeTooltip(e,n){
  const t=document.getElementById("tooltip");
  t.innerHTML=`<strong>${n.name}</strong><div>${n.desc||""}</div>`;
  t.classList.add("active");
  t.style.left=(e.clientX+15)+"px";
  t.style.top=(e.clientY+15)+"px";
}
function hideTooltip(){document.getElementById("tooltip").classList.remove("active");}

// ==== HIGHLIGHT =============================================================
function highlightFromNode(id){
  const near=new Set([id]);
  adjacency[id].forEach(n=>near.add(n));

  currentSvg.querySelectorAll(".node-group").forEach(g=>{
    const i=g.dataset.id;
    g.classList.toggle("dim-node",!near.has(i));
    g.classList.toggle("highlight-node",near.has(i));
  });
  currentSvg.querySelectorAll(".link-path").forEach(p=>{
    const l=currentLinks[p.dataset.i];
    const ok=near.has(l.from)&&near.has(l.to);
    p.classList.toggle("dim-link",!ok);
    p.classList.toggle("highlight-link",ok);
  });
}
function clearHighlight(){
  currentSvg.querySelectorAll(".node-group").forEach(g=>g.classList.remove("dim-node","highlight-node"));
  currentSvg.querySelectorAll(".link-path").forEach(p=>p.classList.remove("dim-link","highlight-link"));
}

// ==== NODE SHAPES (MUY SIMPLIFICADO) =======================================
function drawNodeShape(g,n){
  const ns="http://www.w3.org/2000/svg";
  const r=document.createElementNS(ns,"rect");
  r.setAttribute("x",-24); r.setAttribute("y",-16);
  r.setAttribute("width",48); r.setAttribute("height",32);
  r.setAttribute("rx",4);
  r.setAttribute("fill","#455a64");
  r.setAttribute("stroke","#263238");
  g.appendChild(r);
}

// ==== DRAW NODES ============================================================
function drawNode(svg,n){
  const ns="http://www.w3.org/2000/svg";
  const g=document.createElementNS(ns,"g");
  g.setAttribute("class","node-group");
  g.dataset.id=n.id;
  g.setAttribute("transform",`translate(${n.x},${n.y})`);

  drawNodeShape(g,n);

  const label=document.createElementNS(ns,"text");
  label.setAttribute("y",30);
  label.setAttribute("class","node-label");
  label.textContent=n.name;
  g.appendChild(label);

  g.addEventListener("mouseenter",e=>{showNodeTooltip(e,n);highlightFromNode(n.id);});
  g.addEventListener("mousemove",e=>{
    const t=document.getElementById("tooltip");
    t.style.left=(e.clientX+15)+"px";
    t.style.top=(e.clientY+15)+"px";
  });
  g.addEventListener("mouseleave",()=>{hideTooltip();clearHighlight();});

  svg.appendChild(g);
  n.group=g;
}

// ==== DRAW LINKS ============================================================
function drawLink(svg,l,i){
  const ns="http://www.w3.org/2000/svg";
  const p=document.createElementNS(ns,"path");
  p.setAttribute("d",buildLinkPath(l.from,l.to));
  p.setAttribute("class","link-path link-"+(l.kind||"data"));
  p.dataset.i=i;

  p.addEventListener("mouseenter",e=>{
    const tt=document.getElementById("tooltip");
    tt.innerHTML=`<strong>${l.from} ‚Üí ${l.to}</strong>`;
    tt.classList.add("active");
    tt.style.left=(e.clientX+15)+"px";
    tt.style.top=(e.clientY+15)+"px";
    highlightFromNode(l.from);
  });
  p.addEventListener("mouseleave",()=>{hideTooltip();clearHighlight();});

  svg.appendChild(p);
  l.path=p;
}

// ==== UBICACI√ìN DE CONSOLES SaaS ============================================
function placeSaaS(nodes){
  const internet=nodes["internet"];
  if (!internet) return;
  const centerX=internet.x;
  const centerY=getLayerY(5);

  const list=Object.values(nodes).filter(n=>n.type==="cloud-console");
  if (!list.length) return;

  const soc=list.find(n=>n.id.includes("soc"));
  const others=list.filter(n=>n!==soc);

  if (soc){soc.x=centerX; soc.y=centerY-80;}

  let baseX=centerX+180;
  others.forEach((n,i)=>{n.x=baseX+i*90; n.y=centerY+10;});
}

// ==== BUILD ARCHITECTURE (MUY RESUMIDO) =====================================
function buildArchitecture(){
  const nodes={},links=[];

  addNode(nodes,"internet","Internet",5,430,"internet","Salida a Internet");
  addNode(nodes,"fw-perim","FW Perimetral",4,430,"firewall","Firewall Perimetral");
  addNode(nodes,"sw-l2","Switch L2",3,430,"switch","Switch OT");
  addNode(nodes,"plc1","PLC 1",1,300,"plc","PLC 1");
  addNode(nodes,"plc2","PLC 2",1,430,"plc","PLC 2");
  addNode(nodes,"plc3","PLC 3",1,560,"plc","PLC 3");

  addLink(links,"internet","fw-perim","data");
  addLink(links,"sw-l2","fw-perim","data");
  addLink(links,"plc1","sw-l2","data");
  addLink(links,"plc2","sw-l2","data");
  addLink(links,"plc3","sw-l2","data");

  if (document.getElementById("sol-fw-ot").checked){
    addNode(nodes,"fw-ot","FW OT",3.5,430,"firewall-brand","FW OT",getSelectedBrand("fw-ot-brand"));
    addLink(links,"sw-l2","fw-ot","data");
    addLink(links,"fw-ot","fw-perim","data");
  }

  if (document.getElementById("sol-visibility").checked){
    addNode(nodes,"sensor-vis","Sensor Visibilidad",3,650,"sensor","Sensor Visibilidad",getSelectedBrand("visibility-brand"));
    addLink(links,"sw-l2","sensor-vis","span");
  }

  if (document.getElementById("sol-vuln").checked){
    addNode(nodes,"sensor-vuln","Sensor Vuln",3,800,"sensor","Sensor Vuln",getSelectedBrand("vuln-brand"));
    addLink(links,"sw-l2","sensor-vuln","span");
  }

  if (document.getElementById("sol-access").checked){
    addNode(nodes,"jump","Jump Server",4,650,"server","Jump Server",getSelectedBrand("access-brand"));
    addNode(nodes,"remote-user","Usuario Remoto",5,250,"remote","Remote");
    addLink(links,"remote-user","internet","data");
    addLink(links,"jump","fw-perim","data");
  }

  if (document.getElementById("sol-deception").checked){
    addNode(nodes,"dec","Deception",1,800,"deception","Deception",getSelectedBrand("deception-brand"));
    addLink(links,"dec","sw-l2","data");
  }

  if (document.getElementById("sol-soc").checked){
    addNode(nodes,"soc-collector","Collector SOC",4,250,"soc","Collector",getSelectedBrand("soc-brand"));
    addLink(links,"soc-collector","fw-perim","data");
  }

  return {nodes,links};
}

// ==== UPDATE POSITIONS =======================================================
function updatePositions(){
  Object.values(currentNodes).forEach(n=>{
    if (n.group) n.group.setAttribute("transform",`translate(${n.x},${n.y})`);
  });
  currentLinks.forEach(l=>{if(l.path)l.path.setAttribute("d",buildLinkPath(l.from,l.to));});
}

// ==== UPDATE DIAGRAM ========================================================
function updateDiagram(){
  const c=document.getElementById("diagram-container");
  const w=c.clientWidth||1000;
  const h=purdueLayers.reduce((s,l)=>s+l.height,0);

  c.innerHTML="";
  const svg=createSvg(w,h);
  currentSvg=svg;

  drawLayers(svg,w);

  const arch=buildArchitecture();
  currentNodes=arch.nodes;
  currentLinks=arch.links;

  currentLinks.forEach((l,i)=>drawLink(svg,l,i));
  Object.values(currentNodes).forEach(n=>drawNode(svg,n));

  placeSaaS(currentNodes);
  updatePositions();

  c.appendChild(svg);
  buildAdjacency();
}

// ==== EVENTOS ===============================================================
document.addEventListener("DOMContentLoaded",()=>{
  renderGuests();
  document.getElementById("reservationForm").addEventListener("change",updateDiagram);
});
</script>
</body>
</html>
