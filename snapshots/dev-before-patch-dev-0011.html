<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Showroom IT/OT - SHOTv18</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
  color:#e0e0e0;
  min-height:100vh;
  padding:20px;
}

/* Nuevo layout general */
.page-container{
  max-width:1800px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:25px;
}

.header{
  text-align:center;
  padding:20px;
  background:linear-gradient(135deg,#0f3460 0%,#16213e 100%);
  border-radius:10px;
  box-shadow:0 4px 15px rgba(0,0,0,.3);
}
.header h1{
  color:#fff;
  font-size:2.5em;
  text-shadow:2px 2px 4px rgba(0,0,0,.5);
}

/* Panel formulario (ex Paso 1) */
.form-panel{
  background:linear-gradient(135deg,#1e2a3a 0%,#243447 100%);
  padding:30px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  border:1px solid #2d3e50;
}
.form-panel h2{
  margin-bottom:20px;
}

/* Dos columnas: tecnolog√≠as (30%) + diagrama (70%) */
.content-two-columns{
  display:grid;
  grid-template-columns:minmax(320px, 380px) 1fr;
  gap:16px;
  align-items:start;
}

/* Panel de opciones de tecnolog√≠a */
.tech-options{
  background:linear-gradient(135deg,#1e2a3a 0%,#243447 100%);
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  border:1px solid #2d3e50;
  max-height:calc(100vh - 260px);
  overflow:auto;
  min-height:0;
}

.form-group{margin-bottom:20px}
.form-group label{
  display:block;
  margin-bottom:8px;
  color:#a8dadc;
  font-weight:600;
  font-size:.95em;
}
.form-group input,
.form-group textarea,
.form-group select{
  width:100%;
  padding:12px;
  border:2px solid #2d3e50;
  border-radius:6px;
  background:#1a2332;
  color:#e0e0e0;
  font-size:1em;
  transition:all .3s;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus{
  outline:none;
  border-color:#ff6b35;
  box-shadow:0 0 10px rgba(255,107,53,.3);
}
.form-group textarea{
  resize:vertical;
  min-height:80px;
}
.step-panel{display:none;}
.step-panel.active{display:block;}
.error-message{
  color:#e63946;
  font-size:.8em;
  margin-top:6px;
  display:block;
}
.attendee-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.attendee-row input{
  flex:1;
  min-width:160px;
}
.attendee-remove{
  padding:10px 12px;
  border:none;
  border-radius:6px;
  background:#e63946;
  color:#fff;
  font-size:.8em;
  cursor:pointer;
}
.summary-section{
  margin-top:20px;
  background:#1a2332;
  border:1px solid #2d3e50;
  border-radius:8px;
  padding:15px;
}
.summary-section h3{
  color:#ff6b35;
  margin-bottom:10px;
}
.summary-list{
  list-style:none;
  padding-left:0;
  margin:0;
}
.summary-list li{
  margin-bottom:6px;
  color:#cfd8dc;
  font-size:.9em;
}
.guest-form{
  display:flex;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.guest-form input{
  flex:1;
  min-width:140px;
}
.btn-guest-add{
  padding:10px 16px;
  border:none;
  border-radius:6px;
  background:#457b9d;
  color:#fff;
  font-size:.85em;
  font-weight:600;
  cursor:pointer;
  transition:all .3s;
  white-space:nowrap;
}
.btn-guest-add:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,.3);
}
#guestList{
  margin-top:5px;
}
.guest-list-item{
  font-size:.85em;
  color:#cfd8dc;
  margin-bottom:4px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.guest-text{
  flex:1;
}
.guest-actions{
  display:flex;
  gap:6px;
}
.guest-btn{
  padding:3px 8px;
  border:none;
  border-radius:4px;
  font-size:.75em;
  cursor:pointer;
}
.guest-btn.edit{
  background:#457b9d;
  color:#fff;
}
.guest-btn.delete{
  background:#e63946;
  color:#fff;
}

  /* Calendario y selector de horas */
.calendar-time-wrapper{
  display:grid;
  grid-template-columns:1.2fr 0.8fr;
  gap:16px;
  align-items:start;
}
.calendar-wrapper,.time-selector{
  background:#1a2332;
  border:2px solid #2d3e50;
  border-radius:8px;
  padding:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
.calendar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.calendar-month{
  font-weight:700;
  text-transform:capitalize;
}
.calendar-nav{
  background:#457b9d;
  color:#fff;
  border:none;
  border-radius:6px;
  width:32px;
  height:32px;
  cursor:pointer;
  font-size:18px;
}
.calendar-weekdays,.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.calendar-weekdays span{
  text-align:center;
  font-size:.85em;
  color:#a8dadc;
  font-weight:600;
}
.calendar-day{
  width:100%;
  padding:10px 0;
  border:none;
  border-radius:6px;
  background:#1f2d3d;
  color:#e0e0e0;
  cursor:pointer;
  transition:all .2s;
}
.calendar-day:hover{filter:brightness(1.05)}
.available-day{
  border:1px solid #2ecc71;
  background:rgba(46,204,113,.12);
}
.unavailable-day{
  border:1px solid #e63946;
  background:rgba(230,57,70,.15);
  color:#e63946;
  cursor:not-allowed;
}
.selected-day{
  box-shadow:0 0 0 2px #ff6b35 inset;
}
.time-selector label{color:#a8dadc;font-weight:600;margin-bottom:8px;display:block}
#requestedTime{
  width:100%;
  padding:12px;
  border:2px solid #2d3e50;
  border-radius:6px;
  background:#1a2332;
  color:#e0e0e0;
  font-size:1em;
}
#requestedTime option.time-available{color:#2ecc71;}
#requestedTime option.time-disabled{color:#e63946;}
.time-helper{
  margin-top:10px;
  font-size:.85em;
  color:#cfd8dc;
}
@media(max-width:900px){
  .calendar-time-wrapper{grid-template-columns:1fr;}
}

/* Soluciones */
.solutions-section{margin-top:5px}
.solution-item{
  margin-bottom:20px;
  padding:15px;
  background:#1a2332;
  border-radius:8px;
  border-left:4px solid #ff6b35;
}
.solution-checkbox{
  display:flex;
  align-items:center;
  margin-bottom:10px;
}
.solution-checkbox input[type="checkbox"]{
  width:20px;
  height:20px;
  margin-right:10px;
  cursor:pointer;
}
.solution-checkbox label{
  cursor:pointer;
  font-weight:600;
  color:#ff6b35;
  font-size:1.05em;
}
.brands-group{
  margin-left:30px;
  margin-top:10px;
  display:none;
}
.brands-group.active{display:block}
.brand-option{
  display:flex;
  align-items:center;
  margin-bottom:6px;
}
.brand-option input[type="radio"]{
  width:18px;
  height:18px;
  margin-right:8px;
  cursor:pointer;
}
.brand-option label{
  cursor:pointer;
  color:#a8dadc;
  font-size:.9em;
}
.disabled-option{
  opacity:.45;
  filter:grayscale(0.7);
  pointer-events:none;
}
.disabled-option label{
  cursor:not-allowed;
}
.disabled-option input{
  cursor:not-allowed;
}

/* Botones generales */
.btn{
  padding:15px 25px;
  border:none;
  border-radius:8px;
  font-size:1em;
  font-weight:600;
  cursor:pointer;
  transition:all .3s;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
.btn-primary{
  background:linear-gradient(135deg,#ff6b35 0%,#e85d2a 100%);
  color:#fff;
}
.btn-primary:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 15px rgba(255,107,53,.4);
}
.btn:disabled{
  opacity:.5;
  cursor:not-allowed;
}

/* Footer con bot√≥n Enviar y fallback */
.footer-actions{
  display:flex;
  justify-content:center;
  padding:20px;
}
.footer-actions-inner{
  max-width:800px;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
}

/* Fallback mailto */
.fallback-section{
  width:100%;
  margin-top:5px;
  padding:20px;
  background:#1a2332;
  border-radius:8px;
  border:2px solid #ff6b35;
}
.fallback-section h3{
  color:#ff6b35;
  margin-bottom:15px;
}
.fallback-section textarea{
  width:100%;
  min-height:200px;
  padding:12px;
  background:#0f1923;
  color:#e0e0e0;
  border:1px solid #2d3e50;
  border-radius:6px;
  font-family:monospace;
  font-size:.9em;
}

/* Panel diagrama */
.diagram-panel{
  background:linear-gradient(135deg,#1e2a3a 0%,#243447 100%);
  padding:25px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  border:1px solid #2d3e50;
  position:relative;
  min-height:0;
}
.diagram-panel h2{
  color:#ff6b35;
  margin-bottom:10px;
  font-size:1.4em;
}
.diagram-panel p{
  font-size:.85em;
  color:#a8dadc;
  margin-bottom:10px;
}
.diagram-note{
  margin-top:12px;
  font-size:.85em;
  color:#cfd8dc;
}
#diagram-container{
  width:100%;
  height:calc(100vh - 260px);
  min-height:520px;
  max-height:980px;
  position:relative;
  background:#0f1923;
  border-radius:8px;
  overflow:auto;
}

/* Tooltip y estilos de nodos/enlaces */
.tooltip{
  position:fixed;
  background:rgba(30,42,58,.95);
  color:#e0e0e0;
  padding:10px 14px;
  border-radius:8px;
  border:2px solid #ff6b35;
  pointer-events:none;
  z-index:1000;
  box-shadow:0 4px 15px rgba(0,0,0,.5);
  display:none;
  max-width:320px;
  font-size:.85em;
}
.tooltip.active{display:block}
.tooltip strong{
  color:#ff6b35;
  display:block;
  margin-bottom:4px;
  font-size:1em;
}
.tooltip .layer{
  color:#a8dadc;
  font-size:.8em;
  margin-bottom:4px;
}
.tooltip .description{
  color:#c0c0c0;
  font-size:.8em;
  line-height:1.3;
}
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1500;
  padding:20px;
}
.modal-content{
  background:#1e2a3a;
  border:1px solid #2d3e50;
  border-radius:10px;
  padding:24px;
  max-width:420px;
  width:100%;
  box-shadow:0 12px 30px rgba(0,0,0,.45);
  text-align:center;
}
.modal-content h3{
  margin-bottom:12px;
  color:#a8dadc;
}
.modal-content p{
  margin-bottom:16px;
  color:#e0e0e0;
}
.modal-content .btn{
  margin-top:4px;
  width:100%;
}

.node-group{
  cursor:grab;
  transition:opacity .2s;
}
.node-group:active{cursor:grabbing}
.node-body{stroke-width:2;}
.node-label{
  font-size:11px;
  font-weight:600;
  fill:#e0e0e0;
}
.link-path{
  fill:none;
  stroke-width:2;
  opacity:.7;
  transition:opacity .2s,stroke-width .15s;
}
.link-data{stroke:#ff6b35;}
.link-mgmt{stroke:#4ecca3;stroke-dasharray:6 4;}
.link-span{stroke:#a8dadc;stroke-dasharray:3 3;}
.link-api{stroke:#e63946;stroke-dasharray:4 4;}
.dim-node{opacity:.18;}
.dim-link{opacity:.18;}
.highlight-node{
  opacity:1;
  filter:drop-shadow(0 0 6px rgba(255,255,255,.5));
}
.highlight-link{
  opacity:1;
  stroke-width:3;
}
.layer-rect{
  stroke:#2d3e50;
  stroke-width:1;
}
.layer-label{
  font-size:11px;
  fill:#a8dadc;
  font-weight:600;
}
.cloud-label{
  font-size:10px;
  fill:#e0e0e0;
}

@media(max-width:1000px){
  .content-two-columns{
    grid-template-columns:1fr;
  }
}
</style>
</head>
<body>

<div id="version-badge" style="position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:6px 12px;border-radius:6px;font-size:11px;z-index:9999;">DEV | versi√≥n no disponible</div>

<div class="page-container">

  <!-- ENCABEZADO -->
  <div class="header">
    <h1>üè≠ Showroom IT/OT</h1>
  </div>

  <!-- STEP 1: FORMULARIO -->
  <div class="form-panel step-panel active" id="step-1">
    <h2>Paso 1 de 3 ¬∑ Formulario de visita</h2>

    <h3 style="margin-bottom:12px;color:#ff6b35;">A) Log√≠stica de la visita</h3>
    <div class="form-group">
      <label for="visitType">Tipo de visita (Presencial / Virtual)</label>
      <select id="visitType">
        <option value="">Selecciona una opci√≥n</option>
        <option value="Physical">Presencial</option>
        <option value="Virtual">Virtual</option>
      </select>
    </div>
    <div class="form-group">
      <label for="visitDate">Fecha de visita *</label>
      <input type="date" id="visitDate" required>
      <span class="error-message" id="error-visitDate"></span>
    </div>
    <div class="form-group">
      <label for="visitTime">Hora de visita *</label>
      <input type="time" id="visitTime" required>
      <span class="error-message" id="error-visitTime"></span>
    </div>
    <div class="form-group">
      <label for="presentationLanguage">Idioma de presentaci√≥n (Espa√±ol / Ingl√©s)</label>
      <select id="presentationLanguage">
        <option value="">Selecciona una opci√≥n</option>
        <option value="Spanish">Espa√±ol</option>
        <option value="English">Ingl√©s</option>
      </select>
    </div>
    <div class="form-group">
      <label for="coffeeBreak">Receso de caf√© *</label>
      <select id="coffeeBreak" required>
        <option value="">Selecciona una opci√≥n</option>
        <option value="Yes">S√≠</option>
        <option value="No">No</option>
      </select>
      <span class="error-message" id="error-coffeeBreak"></span>
    </div>
    <div class="form-group" id="costCenterGroup">
      <label for="costCenter">Centro de costos *</label>
      <input type="text" id="costCenter" placeholder="Centro de costos" disabled>
      <span class="error-message" id="error-costCenter"></span>
    </div>

    <h3 style="margin:20px 0 12px;color:#ff6b35;">B) Datos del cliente</h3>
    <div class="form-group">
      <label for="companyName">Empresa (cliente) *</label>
      <input type="text" id="companyName" placeholder="Ej: ACME Manufacturing" required>
      <span class="error-message" id="error-companyName"></span>
    </div>
    <div class="form-group">
      <label for="sector">Sector / Industria</label>
      <input type="text" id="sector" placeholder="Ej: Automotriz, Manufactura, Energ√≠a...">
    </div>
    <div class="form-group">
      <label for="subsector">Subsector</label>
      <input type="text" id="subsector" placeholder="Ej: Componentes, Alimentos, Retail">
    </div>
    <div class="form-group">
      <label for="sitesCount">N√∫mero de sitios / plantas</label>
      <input type="text" id="sitesCount" placeholder="Ej: 3 plantas, 12 sitios">
    </div>
    <div class="form-group">
      <label for="annualRevenue">Facturaci√≥n anual (MXN)</label>
      <input type="text" id="annualRevenue" placeholder="MXN">
    </div>

    <h3 style="margin:20px 0 12px;color:#ff6b35;">C) Datos comerciales internos</h3>
    <div class="form-group">
      <label for="salesManager">Gerente comercial *</label>
      <input type="text" id="salesManager" required>
      <span class="error-message" id="error-salesManager"></span>
    </div>
    <div class="form-group">
      <label for="accountExecutive">Ejecutivo comercial *</label>
      <input type="text" id="accountExecutive" required>
      <span class="error-message" id="error-accountExecutive"></span>
    </div>
    <div class="form-group">
      <label for="corporateCuc">CUC corporativo</label>
      <input type="text" id="corporateCuc">
    </div>
    <div class="form-group">
      <label for="opportunityStatus">Estatus de la oportunidad</label>
      <input type="text" id="opportunityStatus">
    </div>
    <div class="form-group">
      <label for="opportunityProject">Nombre o ID de oportunidad / proyecto</label>
      <input type="text" id="opportunityProject">
    </div>
    <div class="form-group">
      <label for="topNumber">N√∫mero TOP</label>
      <input type="text" id="topNumber">
    </div>

    <h3 style="margin:20px 0 12px;color:#ff6b35;">D) Asistentes (cliente + Scitum/Telmex)</h3>
    <div class="form-group">
      <label>Asistentes del cliente</label>
      <div id="clientAttendeesList"></div>
      <button type="button" class="btn-guest-add" id="addClientAttendee">Agregar invitado</button>
    </div>
    <div class="form-group">
      <label>Asistentes de Scitum/Telmex</label>
      <div id="internalAttendeesList"></div>
      <button type="button" class="btn-guest-add" id="addInternalAttendee">Agregar invitado</button>
    </div>

    <h3 style="margin:20px 0 12px;color:#ff6b35;">E) Contexto estrat√©gico</h3>
    <div class="form-group">
      <label for="visitObjective">Objetivo de la visita</label>
      <textarea id="visitObjective"></textarea>
    </div>
    <div class="form-group">
      <label for="customerDescription">Descripci√≥n del cliente, procesos cr√≠ticos y operaci√≥n</label>
      <textarea id="customerDescription"></textarea>
    </div>
    <div class="form-group">
      <label for="mainProblem">Problema principal a resolver</label>
      <textarea id="mainProblem"></textarea>
    </div>
    <div class="form-group">
      <label for="maturityLevel">Nivel de madurez en ciberseguridad</label>
      <select id="maturityLevel">
        <option value="">Selecciona una opci√≥n</option>
        <option value="Low">Bajo</option>
        <option value="Medium">Medio</option>
        <option value="High">Alto</option>
        <option value="Unknown">Desconocido</option>
      </select>
    </div>

    <div class="footer-actions">
      <div class="footer-actions-inner">
        <button type="button" class="btn btn-primary" id="toStep2">Siguiente: Diagrama</button>
      </div>
    </div>
  </div>

  <!-- STEP 2: DIAGRAMA + SOLUCIONES -->
  <div class="step-panel" id="step-2">
    <h2 style="margin-bottom:20px;">Paso 2 de 3 ¬∑ Diagrama y selecci√≥n de soluciones</h2>
    <!-- DOS COLUMNAS: TECNOLOG√çAS + DIAGRAMA -->
    <div class="content-two-columns">

    <!-- OPCIONES DE TECNOLOG√çA -->
    <div class="tech-options">
      <form id="reservationForm">
        <div class="solutions-section">
          <h3 style="color:#a8dadc;margin-bottom:15px;">Soluciones a demostrar *</h3>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-fw-ot" onchange="toggleBrands('fw-ot')">
              <label for="sol-fw-ot">FW OT (Firewall OT)</label>
            </div>
            <div class="brands-group" id="brands-fw-ot">
              <div class="brand-option">
                <input type="radio" id="fw-fortinet" name="fw-ot-brand" value="Fortinet">
                <label for="fw-fortinet">Fortinet</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="fw-checkpoint" name="fw-ot-brand" value="Check Point" disabled>
                <label for="fw-checkpoint">Check Point</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="fw-txone" name="fw-ot-brand" value="TXOne Networks" disabled>
                <label for="fw-txone">TXOne Networks</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="fw-paloalto" name="fw-ot-brand" value="Palo Alto Networks" disabled>
                <label for="fw-paloalto">Palo Alto Networks</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-visibility" onchange="toggleBrands('visibility')">
              <label for="sol-visibility">Visibilidad de Red OT</label>
            </div>
            <div class="brands-group" id="brands-visibility">
              <div class="brand-option">
                <input type="radio" id="vis-tenable" name="visibility-brand" value="Tenable OT">
                <label for="vis-tenable">Tenable OT</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="vis-nozomi" name="visibility-brand" value="Nozomi" disabled>
                <label for="vis-nozomi">Nozomi Networks</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="vis-claroty" name="visibility-brand" value="Claroty" disabled>
                <label for="vis-claroty">Claroty</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-vuln" onchange="toggleBrands('vuln')">
              <label for="sol-vuln">Gesti√≥n de Vulnerabilidades OT</label>
            </div>
            <div class="brands-group" id="brands-vuln">
              <div class="brand-option">
                <input type="radio" id="vuln-tenable" name="vuln-brand" value="Tenable OT">
                <label for="vuln-tenable">Tenable OT</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="vuln-nozomi" name="vuln-brand" value="Nozomi" disabled>
                <label for="vuln-nozomi">Nozomi Networks</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="vuln-claroty" name="vuln-brand" value="Claroty" disabled>
                <label for="vuln-claroty">Claroty</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-ips" onchange="toggleBrands('ips')">
              <label for="sol-ips">IPS (Sistema de Prevenci√≥n de Intrusiones)</label>
            </div>
            <div class="brands-group" id="brands-ips">
              <div class="brand-option">
                <input type="radio" id="ips-txone" name="ips-brand" value="TXOne Networks">
                <label for="ips-txone">TXOne Networks</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox disabled-option" aria-disabled="true">
              <input type="checkbox" id="sol-access" onchange="toggleBrands('access')" disabled>
              <label for="sol-access">Acceso Seguro / ZTNA</label>
            </div>
            <div class="brands-group active disabled-option" id="brands-access" aria-disabled="true">
              <div class="brand-option">
                <input type="radio" id="access-cyolo" name="access-brand" value="Cyolo" disabled>
                <label for="access-cyolo">Cyolo</label>
              </div>
              <div class="brand-option">
                <input type="radio" id="access-claroty" name="access-brand" value="Claroty" disabled>
                <label for="access-claroty">Claroty</label>
              </div>
              <div class="brand-option">
                <input type="radio" id="access-fortinet" name="access-brand" value="Fortinet" disabled>
                <label for="access-fortinet">Fortinet</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-deception" onchange="toggleBrands('deception')">
              <label for="sol-deception">Deception (Se√±uelos OT)</label>
            </div>
            <div class="brands-group" id="brands-deception">
              <div class="brand-option">
                <input type="radio" id="dec-zscaler" name="deception-brand" value="Zscaler">
                <label for="dec-zscaler">Zscaler</label>
              </div>
              <div class="brand-option disabled-option" aria-disabled="true">
                <input type="radio" id="dec-fortinet" name="deception-brand" value="Fortinet" disabled>
                <label for="dec-fortinet">Fortinet</label>
              </div>
            </div>
          </div>

          <div class="solution-item">
            <div class="solution-checkbox">
              <input type="checkbox" id="sol-soc" onchange="toggleBrands('soc')">
              <label for="sol-soc">SOC (SIEM / Monitoreo)</label>
            </div>
            <div class="brands-group" id="brands-soc">
              <div class="brand-option">
                <input type="radio" id="soc-splunk" name="soc-brand" value="Splunk">
                <label for="soc-splunk">Splunk</label>
              </div>
            </div>
          </div>

        </div>
      </form>
    </div>

    <!-- DIAGRAMA -->
    <div class="diagram-panel">
      <h2>Diagrama de la arquitectura de la maqueta</h2>
      <p>Pasa el cursor sobre los componentes o l√≠neas para ver detalles. Los componentes conectados se resaltan autom√°ticamente.</p>
      <div id="diagram-container"></div>
      <p class="diagram-note">Nota: Las tecnolog√≠as actualmente deshabilitadas se ir√°n habilitando progresivamente conforme se avance en su implementaci√≥n dentro de la maqueta del showroom.</p>
    </div>

    </div>
    <div class="footer-actions">
      <div class="footer-actions-inner" style="flex-direction:row;justify-content:space-between;">
        <button type="button" class="btn" id="backToStep1">Volver al formulario</button>
        <button type="button" class="btn btn-primary" id="toStep3">Siguiente: Confirmaci√≥n</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: CONFIRMACI√ìN -->
  <div class="form-panel step-panel" id="step-3">
    <h2>Paso 3 de 3 ¬∑ Confirmaci√≥n</h2>
    <div id="confirmationSummary"></div>

    <div class="footer-actions">
      <div class="footer-actions-inner" style="flex-direction:row;justify-content:space-between;">
        <button type="button" class="btn" id="backToStep1FromSummary">Volver a editar el formulario</button>
        <button type="button" class="btn" id="backToStep2FromSummary">Volver al diagrama</button>
        <button type="button" class="btn btn-primary" id="sendEmail">Enviar solicitud</button>
      </div>
    </div>

    <div id="fallback" style="display:none" class="fallback-section">
      <h3>El enlace mailto es muy largo. Copia el contenido:</h3>
      <p style="margin-bottom:10px;color:#a8dadc;"><strong>Para:</strong> <span id="fallback-to"></span></p>
      <p style="margin-bottom:10px;color:#a8dadc;"><strong>Asunto:</strong> <span id="fallback-subject"></span></p>
      <textarea id="fallback-body" readonly></textarea>
      <button type="button" class="btn btn-primary" style="margin-top:10px;" onclick="copyToClipboard()">Copiar al portapapeles</button>
    </div>
  </div>

</div>

<div id="tooltip" class="tooltip"></div>
<script>
const mailtoRecipient = 'Visitas_Showroom_OT@scitum.com.mx';
const STEP_IDS = ['step-1','step-2','step-3'];
const REQUIRED_FIELDS = [
  {id:'visitDate', label:'Fecha de visita'},
  {id:'visitTime', label:'Hora de visita'},
  {id:'companyName', label:'Empresa (cliente)'},
  {id:'coffeeBreak', label:'Receso de caf√©'},
  {id:'salesManager', label:'Gerente comercial'},
  {id:'accountExecutive', label:'Ejecutivo comercial'}
];

const EMPTY_VALUE = '‚Äî';
const DISPLAY_MAPS = {
  visitType: {Physical:'Presencial', Virtual:'Virtual'},
  presentationLanguage: {Spanish:'Espa√±ol', English:'Ingl√©s'},
  coffeeBreak: {Yes:'S√≠', No:'No'},
  maturityLevel: {Low:'Bajo', Medium:'Medio', High:'Alto', Unknown:'Desconocido'}
};

function formatValue(value){
  const trimmed = value ? value.toString().trim() : '';
  return trimmed.length ? trimmed : EMPTY_VALUE;
}

function formatChoice(value, map){
  if(!value) return '';
  return map && map[value] ? map[value] : value;
}

function showStep(stepId){
  STEP_IDS.forEach(id=>{
    const step = document.getElementById(id);
    if(step) step.classList.toggle('active', id === stepId);
  });
  if(stepId === 'step-3'){
    populateSummary();
  }
  window.scrollTo({top:0, behavior:'smooth'});
}

function toggleCostCenter(){
  const coffeeBreak = document.getElementById('coffeeBreak');
  const costCenterGroup = document.getElementById('costCenterGroup');
  const costCenter = document.getElementById('costCenter');
  const needsCostCenter = coffeeBreak && coffeeBreak.value === 'Yes';
  if(costCenterGroup){
    costCenterGroup.style.display = needsCostCenter ? 'block' : 'none';
  }
  if(costCenter){
    costCenter.disabled = !needsCostCenter;
    costCenter.required = needsCostCenter;
    if(!needsCostCenter){
      costCenter.value = '';
    }
  }
}

function setError(fieldId, message){
  const error = document.getElementById(`error-${fieldId}`);
  if(error){
    error.textContent = message;
  }
}

function clearErrors(){
  document.querySelectorAll('.error-message').forEach(el=>{el.textContent='';});
}

function validateStep1(){
  clearErrors();
  let isValid = true;

  REQUIRED_FIELDS.forEach(field=>{
    const input = document.getElementById(field.id);
    if(!input) return;
    if(!input.value || !input.value.toString().trim()){
      setError(field.id, 'Este campo es obligatorio.');
      isValid = false;
    }
  });

  const coffeeBreak = document.getElementById('coffeeBreak');
  const costCenter = document.getElementById('costCenter');
  if(coffeeBreak && coffeeBreak.value === 'Yes'){
    if(!costCenter || !costCenter.value.trim()){
      setError('costCenter', 'El centro de costos es obligatorio cuando hay coffee break.');
      isValid = false;
    }
  }

  return isValid;
}

function createAttendeeRow({withEmail = false} = {}){
  const row = document.createElement('div');
  row.className = 'attendee-row';

  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  nameInput.placeholder = 'Nombre';

  const roleInput = document.createElement('input');
  roleInput.type = 'text';
  roleInput.placeholder = 'Rol / Puesto';

  row.appendChild(nameInput);
  row.appendChild(roleInput);

  let emailInput = null;
  if(withEmail){
    emailInput = document.createElement('input');
    emailInput.type = 'email';
    emailInput.placeholder = 'Correo electr√≥nico';
    row.appendChild(emailInput);
  }

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.className = 'attendee-remove';
  removeBtn.textContent = 'Quitar';
  removeBtn.addEventListener('click',()=>row.remove());
  row.appendChild(removeBtn);

  return row;
}

function addAttendee(containerId, withEmail){
  const container = document.getElementById(containerId);
  if(!container) return;
  const row = createAttendeeRow({withEmail});
  container.appendChild(row);
}

function getAttendeeData(containerId, withEmail){
  const container = document.getElementById(containerId);
  if(!container) return [];
  const rows = Array.from(container.querySelectorAll('.attendee-row'));
  return rows.map(row=>{
    const inputs = row.querySelectorAll('input');
    const name = inputs[0]?.value?.trim() || '';
    const role = inputs[1]?.value?.trim() || '';
    const email = withEmail ? (inputs[2]?.value?.trim() || '') : '';
    return {name, role, email};
  }).filter(item=>item.name || item.role || item.email);
}

function getFormData(){
  return {
    visitType: document.getElementById('visitType')?.value || '',
    visitDate: document.getElementById('visitDate')?.value || '',
    visitTime: document.getElementById('visitTime')?.value || '',
    presentationLanguage: document.getElementById('presentationLanguage')?.value || '',
    coffeeBreak: document.getElementById('coffeeBreak')?.value || '',
    costCenter: document.getElementById('costCenter')?.value || '',
    companyName: document.getElementById('companyName')?.value || '',
    sector: document.getElementById('sector')?.value || '',
    subsector: document.getElementById('subsector')?.value || '',
    sitesCount: document.getElementById('sitesCount')?.value || '',
    annualRevenue: document.getElementById('annualRevenue')?.value || '',
    salesManager: document.getElementById('salesManager')?.value || '',
    accountExecutive: document.getElementById('accountExecutive')?.value || '',
    corporateCuc: document.getElementById('corporateCuc')?.value || '',
    opportunityStatus: document.getElementById('opportunityStatus')?.value || '',
    opportunityProject: document.getElementById('opportunityProject')?.value || '',
    topNumber: document.getElementById('topNumber')?.value || '',
    clientAttendees: getAttendeeData('clientAttendeesList', true),
    internalAttendees: getAttendeeData('internalAttendeesList', false),
    visitObjective: document.getElementById('visitObjective')?.value || '',
    customerDescription: document.getElementById('customerDescription')?.value || '',
    mainProblem: document.getElementById('mainProblem')?.value || '',
    maturityLevel: document.getElementById('maturityLevel')?.value || ''
  };
}

function renderSummarySection(title, items){
  const listItems = items.map(item=>{
    return `<li><strong>${item.label}:</strong> ${item.value}</li>`;
  }).join('');
  return `
    <div class="summary-section">
      <h3>${title}</h3>
      <ul class="summary-list">${listItems}</ul>
    </div>
  `;
}

function formatAttendees(attendees, withEmail){
  if(!attendees.length){
    return `<li>${EMPTY_VALUE}</li>`;
  }
  return attendees.map((attendee, index)=>{
    const name = formatValue(attendee.name);
    const role = formatValue(attendee.role);
    if(withEmail){
      const email = formatValue(attendee.email);
      return `<li>${index+1}. ${name} ‚Äî ${role} ‚Äî ${email}</li>`;
    }
    return `<li>${index+1}. ${name} ‚Äî ${role}</li>`;
  }).join('');
}

function populateSummary(){
  const data = getFormData();
  const solutions = getSelectedSolutions();
  const summary = document.getElementById('confirmationSummary');
  if(!summary) return;

  const sectionsHtml = [
    renderSummarySection('A) Log√≠stica de la visita', [
      {label:'Tipo de visita', value: formatValue(formatChoice(data.visitType, DISPLAY_MAPS.visitType))},
      {label:'Fecha de visita', value: formatValue(data.visitDate)},
      {label:'Hora de visita', value: formatValue(data.visitTime)},
      {label:'Idioma de presentaci√≥n', value: formatValue(formatChoice(data.presentationLanguage, DISPLAY_MAPS.presentationLanguage))},
      {label:'Receso de caf√©', value: formatValue(formatChoice(data.coffeeBreak, DISPLAY_MAPS.coffeeBreak))},
      {label:'Centro de costos', value: formatValue(data.coffeeBreak === 'Yes' ? data.costCenter : '')}
    ]),
    renderSummarySection('B) Datos del cliente', [
      {label:'Empresa (cliente)', value: formatValue(data.companyName)},
      {label:'Sector / Industria', value: formatValue(data.sector)},
      {label:'Subsector', value: formatValue(data.subsector)},
      {label:'N√∫mero de sitios / plantas', value: formatValue(data.sitesCount)},
      {label:'Facturaci√≥n anual (MXN)', value: formatValue(data.annualRevenue)}
    ]),
    renderSummarySection('C) Datos comerciales internos', [
      {label:'Gerente comercial', value: formatValue(data.salesManager)},
      {label:'Ejecutivo comercial', value: formatValue(data.accountExecutive)},
      {label:'CUC corporativo', value: formatValue(data.corporateCuc)},
      {label:'Estatus de la oportunidad', value: formatValue(data.opportunityStatus)},
      {label:'Nombre o ID de oportunidad / proyecto', value: formatValue(data.opportunityProject)},
      {label:'N√∫mero TOP', value: formatValue(data.topNumber)}
    ]),
    `
      <div class="summary-section">
        <h3>D) Asistentes (cliente + Scitum/Telmex)</h3>
        <strong>Asistentes del cliente</strong>
        <ul class="summary-list">${formatAttendees(data.clientAttendees, true)}</ul>
        <strong>Asistentes de Scitum/Telmex</strong>
        <ul class="summary-list">${formatAttendees(data.internalAttendees, false)}</ul>
      </div>
    `,
    renderSummarySection('E) Contexto estrat√©gico', [
      {label:'Objetivo de la visita', value: formatValue(data.visitObjective)},
      {label:'Descripci√≥n del cliente, procesos cr√≠ticos y operaci√≥n', value: formatValue(data.customerDescription)},
      {label:'Problema principal a resolver', value: formatValue(data.mainProblem)},
      {label:'Nivel de madurez en ciberseguridad', value: formatValue(formatChoice(data.maturityLevel, DISPLAY_MAPS.maturityLevel))}
    ]),
    `
      <div class="summary-section">
        <h3>F) Diagrama / Soluciones seleccionadas</h3>
        <ul class="summary-list">
          ${solutions.length ? solutions.map((s, idx)=>`<li>${idx+1}. ${s.name} ‚Äî ${formatValue(s.brand)}</li>`).join('') : `<li>${EMPTY_VALUE}</li>`}
        </ul>
      </div>
    `
  ];

  summary.innerHTML = sectionsHtml.join('');
}

function buildMailto(){
  if(!validateStep1()){
    showStep('step-1');
    alert('Por favor completa los campos obligatorios.');
    return null;
  }

  const data = getFormData();
  const solutions = getSelectedSolutions();
  const subjectCompany = formatValue(data.companyName);
  const subjectDate = formatValue(data.visitDate);
  const subjectTime = formatValue(data.visitTime);

  const subject = `Solicitud de Visita Showroom OT ‚Äì ${subjectCompany} ‚Äì ${subjectDate} ${subjectTime}`;

  let body = `A) Log√≠stica de la visita\n`;
  body += `- Tipo de visita: ${formatValue(formatChoice(data.visitType, DISPLAY_MAPS.visitType))}\n`;
  body += `- Fecha de visita: ${formatValue(data.visitDate)}\n`;
  body += `- Hora de visita: ${formatValue(data.visitTime)}\n`;
  body += `- Idioma de presentaci√≥n: ${formatValue(formatChoice(data.presentationLanguage, DISPLAY_MAPS.presentationLanguage))}\n`;
  body += `- Receso de caf√©: ${formatValue(formatChoice(data.coffeeBreak, DISPLAY_MAPS.coffeeBreak))}\n`;
  body += `- Centro de costos: ${formatValue(data.coffeeBreak === 'Yes' ? data.costCenter : '')}\n\n`;

  body += `B) Datos del cliente\n`;
  body += `- Empresa (cliente): ${formatValue(data.companyName)}\n`;
  body += `- Sector / Industria: ${formatValue(data.sector)}\n`;
  body += `- Subsector: ${formatValue(data.subsector)}\n`;
  body += `- N√∫mero de sitios / plantas: ${formatValue(data.sitesCount)}\n`;
  body += `- Facturaci√≥n anual (MXN): ${formatValue(data.annualRevenue)}\n\n`;

  body += `C) Datos comerciales internos\n`;
  body += `- Gerente comercial: ${formatValue(data.salesManager)}\n`;
  body += `- Ejecutivo comercial: ${formatValue(data.accountExecutive)}\n`;
  body += `- CUC corporativo: ${formatValue(data.corporateCuc)}\n`;
  body += `- Estatus de la oportunidad: ${formatValue(data.opportunityStatus)}\n`;
  body += `- Nombre o ID de oportunidad / proyecto: ${formatValue(data.opportunityProject)}\n`;
  body += `- N√∫mero TOP: ${formatValue(data.topNumber)}\n\n`;

  body += `D) Asistentes (cliente + Scitum/Telmex)\n`;
  body += `Asistentes del cliente:\n`;
  if(data.clientAttendees.length){
    data.clientAttendees.forEach((attendee, idx)=>{
      body += `- ${idx+1}. ${formatValue(attendee.name)} / ${formatValue(attendee.role)} / ${formatValue(attendee.email)}\n`;
    });
  }else{
    body += `- ${EMPTY_VALUE}\n`;
  }
  body += `Asistentes de Scitum/Telmex:\n`;
  if(data.internalAttendees.length){
    data.internalAttendees.forEach((attendee, idx)=>{
      body += `- ${idx+1}. ${formatValue(attendee.name)} / ${formatValue(attendee.role)}\n`;
    });
  }else{
    body += `- ${EMPTY_VALUE}\n`;
  }
  body += `\n`;

  body += `E) Contexto estrat√©gico\n`;
  body += `- Objetivo de la visita: ${formatValue(data.visitObjective)}\n`;
  body += `- Descripci√≥n del cliente, procesos cr√≠ticos y operaci√≥n: ${formatValue(data.customerDescription)}\n`;
  body += `- Problema principal a resolver: ${formatValue(data.mainProblem)}\n`;
  body += `- Nivel de madurez en ciberseguridad: ${formatValue(formatChoice(data.maturityLevel, DISPLAY_MAPS.maturityLevel))}\n\n`;

  body += `F) Diagrama / Soluciones seleccionadas\n`;
  if(solutions.length){
    solutions.forEach((solution, idx)=>{
      body += `- ${idx+1}. ${solution.name} ‚Äî ${formatValue(solution.brand)}\n`;
    });
  }else{
    body += `- ${EMPTY_VALUE}\n`;
  }

  return {to: mailtoRecipient, subject, body};
}

function sendEmail(){
  const mailData = buildMailto();
  if(!mailData) return;
  const mailtoLink = `mailto:${encodeURIComponent(mailData.to)}?subject=${encodeURIComponent(mailData.subject)}&body=${encodeURIComponent(mailData.body)}`;
  if(mailtoLink.length>1900){
    document.getElementById('fallback-to').textContent = mailData.to;
    document.getElementById('fallback-subject').textContent = mailData.subject;
    document.getElementById('fallback-body').value = mailData.body;
    document.getElementById('fallback').style.display='block';
  }else{
    document.getElementById('fallback').style.display='none';
    window.location.href = mailtoLink;
  }
}

const LAYER_HEIGHT = 130;
const purdueLayers = [
  {level:5, label:'', height:Math.round(LAYER_HEIGHT*1.3)},
  {level:4, label:'Nivel 4 ‚Äì Red Empresarial', height:LAYER_HEIGHT},
  {level:3.5, label:'Nivel 3.5 ‚Äì DMZ IT/OT', height:LAYER_HEIGHT},
  {level:3, label:'Nivel 3 ‚Äì Operaciones del Sitio', height:LAYER_HEIGHT},
  {level:2, label:'Nivel 2 ‚Äì Control de Supervisi√≥n', height:LAYER_HEIGHT},
  {level:1, label:'Nivel 1 ‚Äì Control B√°sico', height:LAYER_HEIGHT},
  {level:0, label:'Nivel 0 ‚Äì Proceso F√≠sico', height:LAYER_HEIGHT}
];
let currentY = 0;
purdueLayers.forEach(l=>{
  l.height = l.height || LAYER_HEIGHT;
  l.y = currentY;
  currentY += l.height;
});

let currentNodes = {};
let currentLinks = [];
let adjacency = {};
let currentSvg = null;
let dragState = null;

const brandLogos = {
  fortinet: {
    color: { primary: '#EE3124', secondary: '#C41E3A', stroke: '#8B1A1A' },
    logo: `<g transform="translate(-30, -30)">
      <rect x="5" y="5" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="22" y="5" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="39" y="5" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="5" y="22" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="39" y="22" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="5" y="39" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="22" y="39" width="15" height="15" fill="#EE3124" rx="2"/>
      <rect x="39" y="39" width="15" height="15" fill="#EE3124" rx="2"/>
    </g>`
  },
  checkpoint: {
    color: { primary: '#E6007E', secondary: '#C4006A', stroke: '#8B004D' },
    logo: `<g transform="translate(-25, -25)">
      <circle cx="25" cy="35" r="20" fill="none" stroke="#E6007E" stroke-width="6"/>
      <circle cx="25" cy="35" r="6" fill="#E6007E"/>
      <rect x="22" y="20" width="6" height="10" fill="#E6007E"/>
      <rect x="30" y="23" width="8" height="4" fill="#E6007E"/>
      <circle cx="38" cy="10" r="8" fill="#000"/>
    </g>`
  },
  txone: {
    color: { primary: '#D72027', secondary: '#A51B1F', stroke: '#7A1417' },
    logo: `<g transform="translate(-25, -25)">
      <circle cx="8" cy="15" r="2" fill="#D72027"/>
      <circle cx="8" cy="22" r="2" fill="#D72027"/>
      <circle cx="8" cy="29" r="2" fill="#D72027"/>
      <circle cx="8" cy="36" r="2" fill="#D72027"/>
      <rect x="14" y="14" width="12" height="2" fill="#D72027"/>
      <rect x="14" y="21" width="16" height="2" fill="#D72027"/>
      <rect x="14" y="28" width="12" height="2" fill="#D72027"/>
      <rect x="14" y="35" width="16" height="2" fill="#D72027"/>
      <path d="M 32 18 L 42 25 L 32 32 Z" fill="#D72027"/>
    </g>`
  },
  paloalto: {
    color: { primary: '#FA582D', secondary: '#E8501E', stroke: '#C4401A' },
    logo: `<g transform="translate(-25, -25)">
      <rect x="10" y="8" width="8" height="35" fill="#FA582D" transform="rotate(-25 14 25)"/>
      <rect x="22" y="8" width="8" height="35" fill="#FA582D" transform="rotate(-25 26 25)"/>
      <rect x="34" y="8" width="8" height="35" fill="#FA582D" transform="rotate(-25 38 25)"/>
    </g>`
  },
  nozomi: {
    color: { primary: '#0099CC', secondary: '#0077AA', stroke: '#005588' },
    logo: `<g transform="translate(-30, -30)">
      <path d="M 15 10 L 25 20 L 15 30 L 5 20 Z" fill="none" stroke="#0099CC" stroke-width="3"/>
      <path d="M 25 20 L 35 30 L 25 40 L 15 30 Z" fill="none" stroke="#0099CC" stroke-width="3"/>
      <path d="M 35 10 L 45 20 L 35 30 L 25 20 Z" fill="none" stroke="#0099CC" stroke-width="3"/>
      <path d="M 45 20 L 55 30 L 45 40 L 35 30 Z" fill="none" stroke="#0099CC" stroke-width="3"/>
    </g>`
  },
  tenable: {
    color: { primary: '#00396B', secondary: '#002A4E', stroke: '#001A30' },
    logo: `<g transform="translate(-25, -25)">
      <circle cx="25" cy="25" r="22" fill="none" stroke="#00396B" stroke-width="3"/>
      <path d="M 15 15 L 25 20 L 15 25 L 10 20 Z M 25 20 L 35 25 L 25 30 L 15 25 Z M 35 15 L 45 20 L 35 25 L 25 20 Z M 25 30 L 35 35 L 25 40 L 15 35 Z" fill="none" stroke="#00396B" stroke-width="2"/>
    </g>`
  },
  cyolo: {
    color: { primary: '#0B7285', secondary: '#15AABF', stroke: '#0B7285' },
    logo: `<g transform="translate(-28,-28)">
      <circle cx="0" cy="0" r="24" fill="#0B7285"/>
      <circle cx="0" cy="0" r="16" fill="none" stroke="#ffffff" stroke-width="3"/>
      <path d="M -6 2 L -1 7 L 7 -5" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </g>`
  },
  claroty: {
    color: { primary: '#E6007E', secondary: '#C4006A', stroke: '#8B004D' },
    logo: `<g transform="translate(-25, -25)">
      <circle cx="25" cy="35" r="20" fill="none" stroke="#E6007E" stroke-width="6"/>
      <circle cx="25" cy="35" r="6" fill="#E6007E"/>
      <rect x="22" y="20" width="6" height="10" fill="#E6007E"/>
      <rect x="30" y="23" width="8" height="4" fill="#E6007E"/>
      <circle cx="38" cy="10" r="8" fill="#000"/>
    </g>`
  },
  zscaler: {
    color: { primary: '#0081FB', secondary: '#0066CC', stroke: '#004C99' },
    logo: `<g transform="translate(-30, -30)">
      <path d="M 10 20 Q 20 10 30 20 Q 40 30 30 40 Q 20 50 10 40 Q 20 30 30 30 Q 40 25 45 30" fill="none" stroke="#0081FB" stroke-width="6"/>
      <path d="M 50 30 Q 40 20 30 30 Q 20 40 30 50 Q 40 60 50 50 Q 40 40 30 40 Q 20 45 15 40" fill="none" stroke="#0081FB" stroke-width="6"/>
    </g>`
  },
  splunk: {
    color: { primary: '#6DB33F', secondary: '#5A9C34', stroke: '#478529' },
    logo: `<g transform="translate(-20, -20)">
      <path d="M 5 30 L 20 15 L 35 30 L 20 45 Z" fill="none" stroke="#6DB33F" stroke-width="4"/>
      <path d="M 20 15 L 25 10 L 30 15" fill="none" stroke="#6DB33F" stroke-width="3"/>
    </g>`
  }
};

function getSelectedBrand(groupName) {
  const radio = document.querySelector(`input[name="${groupName}"]:checked`);
  if (!radio) return null;
  const value = radio.value.trim().toLowerCase();

  const map = {
    fortinet: 'fortinet',
    'check point': 'checkpoint',
    check: 'checkpoint',
    point: 'checkpoint',
    txone: 'txone',
    'palo alto': 'paloalto',
    palo: 'paloalto',
    alto: 'paloalto',
    nozomi: 'nozomi',
    tenable: 'tenable',
    claroty: 'claroty',
    cyolo: 'cyolo',
    zscaler: 'zscaler',
    splunk: 'splunk'
  };

  for (const key in map) {
    if (value.includes(key)) return map[key];
  }
  return null;
}

function getSelectedSolutions(){
  const solutions = [];
  function pick(id,name,group){
    if(document.getElementById(id).checked){
      let brandText = null;
      if(group){
        const r = document.querySelector('input[name="'+group+'"]:checked');
        brandText = r ? r.value : null;
      }
      solutions.push({name,brand:brandText || 'Sin marca seleccionada'});
    }
  }
  pick('sol-fw-ot','FW OT','fw-ot-brand');
  pick('sol-visibility','Visibilidad de Red OT','visibility-brand');
  pick('sol-vuln','Gesti√≥n de Vulnerabilidades OT','vuln-brand');
  pick('sol-ips','IPS','ips-brand');
  pick('sol-access','Acceso Seguro / ZTNA','access-brand');
  pick('sol-deception','Deception (Se√±uelos OT)','deception-brand');
  pick('sol-soc','SOC','soc-brand');
  return solutions;
}

function copyToClipboard(){
  const textarea = document.getElementById('fallback-body');
  const to = document.getElementById('fallback-to').textContent;
  const subject = document.getElementById('fallback-subject').textContent;
  const fullText = `Para: ${to}\n\nAsunto: ${subject}\n\n${textarea.value}`;
  navigator.clipboard.writeText(fullText).then(()=>{
    alert('Contenido copiado al portapapeles');
  }).catch(()=>{
    textarea.select();
    document.execCommand('copy');
    alert('Contenido copiado al portapapeles');
  });
}

/* Purdue helpers */
function getLayerInfo(level){
  return purdueLayers.find(l=>l.level===level);
}
function getLayerCenterY(level){
  const layer = getLayerInfo(level);
  return layer ? layer.y + layer.height/2 : 0;
}

/* Arquitectura IT/OT */
function buildArchitecture(){
  const hasFwOt      = document.getElementById('sol-fw-ot').checked;
  const hasVis       = document.getElementById('sol-visibility').checked;
  const hasVuln      = document.getElementById('sol-vuln').checked;
  const hasIps       = document.getElementById('sol-ips').checked;
  const hasAccess    = document.getElementById('sol-access').checked;
  const hasDeception = document.getElementById('sol-deception').checked;
  const hasSoc       = document.getElementById('sol-soc').checked;

  const fwOtBrand = getSelectedBrand('fw-ot-brand');
  const visBrand = getSelectedBrand('visibility-brand');
  const vulnBrand = getSelectedBrand('vuln-brand');
  const ipsBrand = getSelectedBrand('ips-brand');
  const accessBrand = getSelectedBrand('access-brand');
  const deceptionBrand = getSelectedBrand('deception-brand');
  const socBrand = getSelectedBrand('soc-brand');

  const nodes = {};
  const links = [];

  function addNode(id,name,layer,x,type,description,brand){
    nodes[id] = {id,name,layer,x, y:getLayerCenterY(layer), type,description,brand:brand||null};
  }
  function addLink(from,to,kind,descExtra){
    links.push({from,to,kind:kind||'data',descExtra:descExtra||''});
  }

  addNode('internet','Internet',5,430,'internet','Salida a Internet / Nube p√∫blica');

  const fwPerimX = hasFwOt ? 800 : 430;
  addNode('fw-perim','FW Perimetral',4,fwPerimX,'firewall-perimeter','Firewall perimetral que protege el per√≠metro IT/OT');

  addNode('dc','Servidor de Dominio (DC)',4,200,'server','Controlador de dominio / servicios de autenticaci√≥n');
  addNode('hr-pc','PC Recursos Humanos',4,300,'workstation','Equipo de usuario en red de oficina');
  addNode('sw-l2','Switch L2 OT',3,430,'switch','Switch L2 principal de la red OT');
  addNode('hmi','HMI de Proceso',2,280,'hmi','Interfaz operador-proceso para supervisi√≥n de la planta');
  addNode('eng','Estaci√≥n de Ingenier√≠a',2,580,'workstation','Estaci√≥n de ingenier√≠a para programaci√≥n y mantenimiento de PLCs');
  addNode('plc1','PLC 1',1,260,'plc','Controlador l√≥gico programable ‚Äì L√≠nea 1');
  addNode('plc2','PLC 2',1,430,'plc','Controlador l√≥gico programable ‚Äì L√≠nea 2');
  addNode('plc3','PLC 3',1,600,'plc','Controlador l√≥gico programable ‚Äì L√≠nea 3');
  addNode('motor','Motor',0,240,'motor','Motor el√©ctrico del proceso');
  addNode('actuator','Actuador',0,360,'actuator','Actuador de v√°lvulas / elementos finales');
  addNode('piston','Pist√≥n',0,480,'piston','Pist√≥n neum√°tico / hidr√°ulico');
  addNode('belt','Banda Transportadora',0,600,'belt','Banda para transporte de producto');

  addLink('plc1','motor','data','Control de motor');
  addLink('plc2','actuator','data','Control de actuadores');
  addLink('plc3','belt','data','Control de bandas / pistones');
  addLink('plc3','piston','data','Control de pistones');
  addLink('internet','fw-perim','data','Conectividad hacia/desde Internet');

  let swCoreId = null;

  if(hasFwOt){
    addNode('fw-ot','FW OT',3.5,430,'firewall-brand','Firewall OT en DMZ IT/OT (Nivel 3.5)',fwOtBrand);
    addNode('sw-core','Switch Core IT/OT',4,430,'switch-core','Switch core para segmentaci√≥n IT/OT y tr√°fico Norte-Sur');
    swCoreId = 'sw-core';
    addLink('sw-l2','fw-ot','data','Tr√°fico OT hacia DMZ IT/OT');
    addLink('fw-ot','sw-core','data','Tr√°fico de DMZ hacia Core');
    addLink('sw-core','fw-perim','data','Tr√°fico norte-sur hacia FW perimetral');
    addLink('dc','sw-core','data','Tr√°fico DC ‚Üî Core');
    addLink('hr-pc','sw-core','data','Tr√°fico HR ‚Üî Core');
  }else{
    addLink('dc','fw-perim','data','Tr√°fico DC ‚Üî FW perimetral');
    addLink('hr-pc','fw-perim','data','Tr√°fico HR ‚Üî FW perimetral');
    addLink('sw-l2','fw-perim','data','Tr√°fico OT ‚Üî FW perimetral');
  }

  const hasIpsOption = hasIps;
  if(hasIpsOption){
    addNode('ips','IPS OT',2,430,'ips-brand','IPS inline para inspecci√≥n de tr√°fico OT',ipsBrand);
    addLink('ips','sw-l2','data','IPS en camino hacia el Switch L2');
    addLink('hmi','ips','data','HMI protegida por IPS');
    addLink('eng','ips','data','Estaci√≥n de ingenier√≠a protegida por IPS');
    addLink('plc1','ips','data','PLC 1 protegido por IPS');
    addLink('plc2','ips','data','PLC 2 protegido por IPS');
    addLink('plc3','ips','data','PLC 3 protegido por IPS');
  }else{
    addLink('hmi','sw-l2','data','HMI conectada al SW L2');
    addLink('eng','sw-l2','data','Estaci√≥n de ingenier√≠a conectada al SW L2');
    addLink('plc1','sw-l2','data','PLC 1 conectado al SW L2');
    addLink('plc2','sw-l2','data','PLC 2 conectado al SW L2');
    addLink('plc3','sw-l2','data','PLC 3 conectado al SW L2');
  }

  const spanSource = 'sw-l2';

  if(hasVis){
    addNode('sensor-vis','Sensor Visibilidad OT',3,650,'sensor','Sensor pasivo de visibilidad OT (SPAN)',visBrand);
    addLink(spanSource,'sensor-vis','span','Tr√°fico copiado por puerto SPAN para visibilidad desde SW L2');
  }

  if(hasVuln){
    addNode('sensor-vuln','Sensor Vuln. OT',3,800,'sensor','Sensor de gesti√≥n de vulnerabilidades OT (SPAN)',vulnBrand);
    addLink(spanSource,'sensor-vuln','span','Tr√°fico copiado por puerto SPAN para vulnerabilidades desde SW L2');
  }

  if(hasDeception){
    addNode('dec-server','Servidor Deception (Se√±uelos)',1,800,'deception','Servidor Deception con m√∫ltiples se√±uelos OT simulados',deceptionBrand);
    const deceptionUp = hasIpsOption ? 'ips' : 'sw-l2';
    addLink('dec-server',deceptionUp,'data','Tr√°fico del servidor Deception hacia la red OT');
  }

  if(hasAccess){
    addNode('jump','Jump Server / Basti√≥n',4,650,'server','Jump Server para acceso remoto seguro a OT',accessBrand);
    const upFromJump = swCoreId || 'fw-perim';
    addLink('jump',upFromJump,'data','Acceso administrador desde Jump al Core/FW Perimetral');
    addNode('remote-user','Usuario Remoto',5,250,'remote-user','Usuario remoto accediendo por ZTNA/VPN');
    addLink('remote-user','internet','data','Usuario remoto entra por Internet');
  }

  if(hasSoc){
    addNode('soc-collector','Collector SOC / SIEM',4,200,'soc','Collector / Forwarder hacia SOC (Splunk)',socBrand);
    const socUp = swCoreId || 'fw-perim';
    addLink('soc-collector',socUp,'data','Logs hacia collector SOC');
  }

  const mgmtItems = [];

  if(hasFwOt && fwOtBrand){
    mgmtItems.push({id:'fwot-console', name:'Consola FW OT (SaaS)', target:'fw-ot', brand:fwOtBrand});
  }
  if(hasVis && visBrand){
    mgmtItems.push({id:'vis-console', name:'Consola Visibilidad OT (SaaS)', target:'sensor-vis', brand:visBrand});
  }
  if(hasVuln && vulnBrand){
    mgmtItems.push({id:'vuln-console', name:'Consola Vuln OT (SaaS)', target:'sensor-vuln', brand:vulnBrand});
  }
  if(hasIpsOption && ipsBrand){
    mgmtItems.push({id:'ips-console', name:'Consola IPS OT (SaaS)', target:'ips', brand:ipsBrand});
  }
  if(hasAccess && accessBrand){
    mgmtItems.push({id:'access-console', name:'Consola Acceso Seguro (SaaS)', target:'jump', brand:accessBrand});
  }
  if(hasDeception && deceptionBrand){
    mgmtItems.push({id:'dec-console', name:'Consola Deception (SaaS)', target:'dec-server', brand:deceptionBrand});
  }
  if(hasSoc && socBrand){
    mgmtItems.push({id:'soc-console', name:'Consola SOC / SIEM (SaaS)', target:'soc-collector', brand:socBrand});
  }

  if(mgmtItems.length>0){
    const baseX = 650;
    const step  = 90;
    const baseConsoleY = getLayerCenterY(5) + 25;
    let socConsoleId = null;

    mgmtItems.forEach((m,idx)=>{
      let x = baseX + idx*step;
      addNode(m.id,m.name,5,x,'cloud-console','Consola de gesti√≥n SaaS alcanzable v√≠a Internet',m.brand);
      if(m.id === 'soc-console'){
        nodes[m.id].y = getLayerCenterY(5) - 140;
        socConsoleId = m.id;
      }else{
        nodes[m.id].y = baseConsoleY;
      }
      addLink(m.id,m.target,'mgmt','Gesti√≥n remota desde consola SaaS');
      addLink('internet',m.id,'data','Conectividad Internet ‚Üî Consola SaaS');
    });

    if(socConsoleId){
      mgmtItems.forEach(m=>{
        if(m.id !== socConsoleId){
          addLink(m.id,socConsoleId,'api','Integraci√≥n v√≠a API para el env√≠o de eventos de seguridad');
        }
      });
    }
  }

  return {nodes,links};
}

function createSvg(width,height){
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width',width);
  svg.setAttribute('height',height);
  svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  return svg;
}

function drawLayers(svg,width){
  purdueLayers.forEach(layer=>{
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',0);
    rect.setAttribute('y',layer.y);
    rect.setAttribute('width',width);
    rect.setAttribute('height',layer.height);
    rect.setAttribute('fill','rgba(13,27,42,0.6)');
    rect.setAttribute('class','layer-rect');
    svg.appendChild(rect);

    if(layer.label){
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x',10);
      text.setAttribute('y',layer.y+18);
      text.setAttribute('class','layer-label');
      text.textContent = layer.label;
      svg.appendChild(text);
    }
  });
}

function drawCloudIcon(group){
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d','M -25 5 C -30 5 -35 1 -35 -5 C -35 -12 -29 -16 -24 -16 C -22 -22 -16 -26 -10 -26 C -2 -26 5 -20 6 -13 C 12 -13 17 -8 17 -2 C 17 5 11 10 4 10 L -25 10 Z');
  path.setAttribute('fill','#457b9d');
  path.setAttribute('stroke','#1d3557');
  path.setAttribute('stroke-width','2');
  group.appendChild(path);
}

function drawFirewallWithBrand(group, brand){
  const ns = 'http://www.w3.org/2000/svg';
  const brandData = brandLogos[brand] || brandLogos.fortinet;
  const defs = document.createElementNS(ns,'defs');
  const grad = document.createElementNS(ns,'linearGradient');
  const gradId = `grad-fw-${brand}-${Math.random().toString(36).slice(2)}`;
  grad.setAttribute('id',gradId);
  grad.setAttribute('x1','0%');
  grad.setAttribute('y1','0%');
  grad.setAttribute('x2','100%');
  grad.setAttribute('y2','100%');
  const stop1 = document.createElementNS(ns,'stop');
  stop1.setAttribute('offset','0%');
  stop1.setAttribute('stop-color',brandData.color.primary);
  const stop2 = document.createElementNS(ns,'stop');
  stop2.setAttribute('offset','100%');
  stop2.setAttribute('stop-color',brandData.color.secondary);
  grad.appendChild(stop1);
  grad.appendChild(stop2);
  defs.appendChild(grad);
  group.appendChild(defs);

  const rect = document.createElementNS(ns,'rect');
  rect.setAttribute('x',-25);
  rect.setAttribute('y',-20);
  rect.setAttribute('width',50);
  rect.setAttribute('height',40);
  rect.setAttribute('rx',6);
  rect.setAttribute('fill',`url(#${gradId})`);
  rect.setAttribute('stroke',brandData.color.stroke);
  rect.setAttribute('class','node-body');
  group.appendChild(rect);

  const line = document.createElementNS(ns,'line');
  line.setAttribute('x1',-20);
  line.setAttribute('y1',0);
  line.setAttribute('x2',20);
  line.setAttribute('y2',0);
  line.setAttribute('stroke',brandData.color.stroke);
  line.setAttribute('stroke-width','2');
  group.appendChild(line);

  for(let i=-15;i<=15;i+=10){
    const port = document.createElementNS(ns,'rect');
    port.setAttribute('x',i-2);
    port.setAttribute('y',8);
    port.setAttribute('width',4);
    port.setAttribute('height',8);
    port.setAttribute('fill',brandData.color.stroke);
    group.appendChild(port);
  }
}

function drawFirewallPerimeter(group){
  const ns = 'http://www.w3.org/2000/svg';
  const defs = document.createElementNS(ns,'defs');
  const grad = document.createElementNS(ns,'linearGradient');
  const gradId = `grad-perim-${Math.random().toString(36).slice(2)}`;
  grad.setAttribute('id',gradId);
  grad.setAttribute('x1','0%');
  grad.setAttribute('y1','0%');
  grad.setAttribute('x2','100%');
  grad.setAttribute('y2','100%');
  const stop1 = document.createElementNS(ns,'stop');
  stop1.setAttribute('offset','0%');
  stop1.setAttribute('stop-color','#ff6b35');
  const stop2 = document.createElementNS(ns,'stop');
  stop2.setAttribute('offset','100%');
  stop2.setAttribute('stop-color','#e85d2a');
  grad.appendChild(stop1);
  grad.appendChild(stop2);
  defs.appendChild(grad);
  group.appendChild(defs);

  const rect = document.createElementNS(ns,'rect');
  rect.setAttribute('x',-25);
  rect.setAttribute('y',-20);
  rect.setAttribute('width',50);
  rect.setAttribute('height',40);
  rect.setAttribute('rx',6);
  rect.setAttribute('fill',`url(#${gradId})`);
  rect.setAttribute('stroke','#d04a1e');
  rect.setAttribute('class','node-body');
  group.appendChild(rect);

  const line = document.createElementNS(ns,'line');
  line.setAttribute('x1',-20);
  line.setAttribute('y1',0);
  line.setAttribute('x2',20);
  line.setAttribute('y2',0);
  line.setAttribute('stroke','#d04a1e');
  line.setAttribute('stroke-width','2');
  group.appendChild(line);

  for(let i=-15;i<=15;i+=10){
    const port = document.createElementNS(ns,'rect');
    port.setAttribute('x',i-2);
    port.setAttribute('y',8);
    port.setAttribute('width',4);
    port.setAttribute('height',8);
        port.setAttribute('fill','#d04a1e');
    group.appendChild(port);
  }
}

function drawManagementConsole(group, brand){
  const ns = 'http://www.w3.org/2000/svg';
  const brandData = brandLogos[brand] || brandLogos.fortinet;

  const defs = document.createElementNS(ns,'defs');
  const grad = document.createElementNS(ns,'linearGradient');
  const gradId = `grad-console-${brand}-${Math.random().toString(36).slice(2)}`;
  grad.setAttribute('id',gradId);
  grad.setAttribute('x1','0%');
  grad.setAttribute('y1','0%');
  grad.setAttribute('x2','100%');
  grad.setAttribute('y2','100%');
  const stop1 = document.createElementNS(ns,'stop');
  stop1.setAttribute('offset','0%');
  stop1.setAttribute('stop-color',brandData.color.primary);
  stop1.setAttribute('stop-opacity','0.2');
  const stop2 = document.createElementNS(ns,'stop');
  stop2.setAttribute('offset','100%');
  stop2.setAttribute('stop-color',brandData.color.secondary);
  stop2.setAttribute('stop-opacity','0.3');
  grad.appendChild(stop1);
  grad.appendChild(stop2);
  defs.appendChild(grad);
  group.appendChild(defs);

  const rect = document.createElementNS(ns,'rect');
  rect.setAttribute('x',-30);
  rect.setAttribute('y',-25);
  rect.setAttribute('width',60);
  rect.setAttribute('height',50);
  rect.setAttribute('rx',6);
  rect.setAttribute('fill',`url(#${gradId})`);
  rect.setAttribute('stroke',brandData.color.primary);
  rect.setAttribute('stroke-width','2');
  rect.setAttribute('class','node-body');
  group.appendChild(rect);

  const logoG = document.createElementNS(ns,'g');
  logoG.setAttribute('transform','translate(-15, -10) scale(0.4)');
  logoG.innerHTML = brandData.logo;
  group.appendChild(logoG);

  for(let i=0; i<3; i++){
    const cy = -15 + i*8;
    const circle = document.createElementNS(ns,'circle');
    circle.setAttribute('cx',15);
    circle.setAttribute('cy',cy);
    circle.setAttribute('r',1.5);
    circle.setAttribute('fill',brandData.color.primary);
    group.appendChild(circle);

    const line = document.createElementNS(ns,'line');
    line.setAttribute('x1',18);
    line.setAttribute('y1',cy);
    line.setAttribute('x2',26);
    line.setAttribute('y2',cy);
    line.setAttribute('stroke',brandData.color.primary);
    line.setAttribute('stroke-width','1.5');
    group.appendChild(line);
  }

  const barData = [8, 14, 10, 16, 12];
  for(let i=0; i<barData.length; i++){
    const barRect = document.createElementNS(ns,'rect');
    barRect.setAttribute('x',-22 + i*9);
    barRect.setAttribute('y',18 - barData[i]);
    barRect.setAttribute('width',6);
    barRect.setAttribute('height',barData[i]);
    barRect.setAttribute('fill',brandData.color.primary);
    barRect.setAttribute('rx',1);
    group.appendChild(barRect);
  }
}

function drawNodeShape(group,node){
  const ns = 'http://www.w3.org/2000/svg';

  if(node.type==='internet'){
    drawCloudIcon(group);
    const label = document.createElementNS(ns,'text');
    label.setAttribute('class','cloud-label');
    label.setAttribute('x',0);
    label.setAttribute('y',18);
    label.setAttribute('text-anchor','middle');
    label.textContent = 'Internet';
    group.appendChild(label);
    return;
  }

  if(node.type==='cloud-console'){
    if(node.brand){
      drawManagementConsole(group, node.brand);
    }else{
      drawCloudIcon(group);
    }
    return;
  }

  if(node.type==='firewall-brand'){
    if(node.brand){
      drawFirewallWithBrand(group, node.brand);
    }else{
      drawFirewallPerimeter(group);
    }
    return;
  }

  if(node.type==='firewall-perimeter'){
    drawFirewallPerimeter(group);
    return;
  }

  if(node.type==='ips-brand'){
    const rect = document.createElementNS(ns,'rect');
    rect.setAttribute('x',-32);
    rect.setAttribute('y',-14);
    rect.setAttribute('width',64);
    rect.setAttribute('height',28);
    rect.setAttribute('rx',6);
    rect.setAttribute('fill','#111827');
    rect.setAttribute('stroke','#7f1d1d');
    rect.setAttribute('class','node-body');
    group.appendChild(rect);

    const top = document.createElementNS(ns,'rect');
    top.setAttribute('x',-32);
    top.setAttribute('y',-14);
    top.setAttribute('width',64);
    top.setAttribute('height',8);
    top.setAttribute('fill','#ff6b35');
    group.appendChild(top);

    const led1 = document.createElementNS(ns,'circle');
    led1.setAttribute('cx',-20);
    led1.setAttribute('cy',0);
    led1.setAttribute('r',2.5);
    led1.setAttribute('fill','#22c55e');
    group.appendChild(led1);

    const led2 = document.createElementNS(ns,'circle');
    led2.setAttribute('cx',-10);
    led2.setAttribute('cy',0);
    led2.setAttribute('r',2.5);
    led2.setAttribute('fill','#ffd166');
    group.appendChild(led2);

    const led3 = document.createElementNS(ns,'circle');
    led3.setAttribute('cx',0);
    led3.setAttribute('cy',0);
    led3.setAttribute('r',2.5);
    led3.setAttribute('fill','#e63946');
    group.appendChild(led3);

    ['10','22'].forEach((xOff)=>{
      const port = document.createElementNS(ns,'rect');
      port.setAttribute('x',parseInt(xOff) - 32);
      port.setAttribute('y',-4);
      port.setAttribute('width',10);
      port.setAttribute('height',10);
      port.setAttribute('fill','#0f1923');
      group.appendChild(port);
    });
    return;
  }

  if(node.type==='switch' || node.type==='switch-core'){
    const rect = document.createElementNS(ns,'rect');
    rect.setAttribute('x',-30);
    rect.setAttribute('y',-15);
    rect.setAttribute('width',60);
    rect.setAttribute('height',30);
    rect.setAttribute('rx',4);
    rect.setAttribute('fill', node.type==='switch-core' ? '#6c757d' : '#34495e');
    rect.setAttribute('stroke','#2c3e50');
    rect.setAttribute('class','node-body');
    group.appendChild(rect);
    for(let i=-24;i<=24;i+=8){
      const port = document.createElementNS(ns,'rect');
      port.setAttribute('x',i);
      port.setAttribute('y',-7);
      port.setAttribute('width',6);
      port.setAttribute('height',14);
      port.setAttribute('fill','#1a252f');
      group.appendChild(port);
    }
    return;
  }

  if(node.type==='server' || node.type==='soc'){
    const rect = document.createElementNS(ns,'rect');
    rect.setAttribute('x',-20);
    rect.setAttribute('y',-28);
    rect.setAttribute('width',40);
    rect.setAttribute('height',56);
    rect.setAttribute('rx',4);
    rect.setAttribute('fill', node.type==='soc' ? '#8d99ae' : '#495057');
    rect.setAttribute('stroke','#343a40');
    rect.setAttribute('class','node-body');
    group.appendChild(rect);
    for(let i=-18;i<=10;i+=15){
      const unit = document.createElementNS(ns,'rect');
      unit.setAttribute('x',-16);
      unit.setAttribute('y',i);
      unit.setAttribute('width',32);
      unit.setAttribute('height',10);
      unit.setAttribute('fill','#6c757d');
      group.appendChild(unit);
    }
    return;
  }

  if(node.type==='workstation' || node.type==='remote-user'){
    const base = document.createElementNS(ns,'rect');
    base.setAttribute('x',-18);
    base.setAttribute('y',10);
    base.setAttribute('width',36);
    base.setAttribute('height',10);
    base.setAttribute('fill','#6c757d');
    base.setAttribute('stroke','#495057');
    base.setAttribute('class','node-body');
    group.appendChild(base);
    const monitor = document.createElementNS(ns,'rect');
    monitor.setAttribute('x',-22);
    monitor.setAttribute('y',-18);
    monitor.setAttribute('width',44);
    monitor.setAttribute('height',28);
    monitor.setAttribute('rx',4);
    monitor.setAttribute('fill', node.type==='remote-user' ? '#3a86ff' : '#2c3e50');
    monitor.setAttribute('stroke','#1a252f');
    group.appendChild(monitor);
    return;
  }

  if(node.type==='hmi'){
    const outer = document.createElementNS(ns,'rect');
    outer.setAttribute('x',-30);
    outer.setAttribute('y',-20);
    outer.setAttribute('width',60);
    outer.setAttribute('height',40);
    outer.setAttribute('rx',10);
    outer.setAttribute('fill','#1e2a3a');
    outer.setAttribute('stroke','#2d3e50');
    outer.setAttribute('class','node-body');
    group.appendChild(outer);

    const screen = document.createElementNS(ns,'rect');
    screen.setAttribute('x',-24);
    screen.setAttribute('y',-14);
    screen.setAttribute('width',48);
    screen.setAttribute('height',26);
    screen.setAttribute('rx',6);
    screen.setAttribute('fill','#0a4d68');
    group.appendChild(screen);

    const bottom = document.createElementNS(ns,'rect');
    bottom.setAttribute('x',-24);
    bottom.setAttribute('y',12);
    bottom.setAttribute('width',48);
    bottom.setAttribute('height',4);
    bottom.setAttribute('fill','#0f1923');
    group.appendChild(bottom);

    const b1 = document.createElementNS(ns,'circle');
    b1.setAttribute('cx',-18);
    b1.setAttribute('cy',14);
    b1.setAttribute('r',2);
    b1.setAttribute('fill','#22c55e');
    group.appendChild(b1);

    const b2 = document.createElementNS(ns,'circle');
    b2.setAttribute('cx',-12);
    b2.setAttribute('cy',14);
    b2.setAttribute('r',2);
    b2.setAttribute('fill','#ffd166');
    group.appendChild(b2);

    const b3 = document.createElementNS(ns,'circle');
    b3.setAttribute('cx',-6);
    b3.setAttribute('cy',14);
    b3.setAttribute('r',2);
    b3.setAttribute('fill','#ff6b35');
    group.appendChild(b3);

    return;
  }

  if(node.type==='plc'){
    const outer = document.createElementNS(ns,'rect');
    outer.setAttribute('x',-32);
    outer.setAttribute('y',-16);
    outer.setAttribute('width',64);
    outer.setAttribute('height',32);
    outer.setAttribute('rx',8);
    outer.setAttribute('fill','#1f2937');
    outer.setAttribute('stroke','#2d3e50');
    outer.setAttribute('class','node-body');
    group.appendChild(outer);

    const m1 = document.createElementNS(ns,'rect');
    m1.setAttribute('x',-26);
    m1.setAttribute('y',-10);
    m1.setAttribute('width',16);
    m1.setAttribute('height',20);
    m1.setAttribute('fill','#0f172a');
    group.appendChild(m1);

    const m2 = document.createElementNS(ns,'rect');
    m2.setAttribute('x',-6);
    m2.setAttribute('y',-10);
    m2.setAttribute('width',16);
    m2.setAttribute('height',20);
    m2.setAttribute('fill','#111827');
    group.appendChild(m2);

    const m3 = document.createElementNS(ns,'rect');
    m3.setAttribute('x',14);
    m3.setAttribute('y',-10);
    m3.setAttribute('width',16);
    m3.setAttribute('height',20);
    m3.setAttribute('fill','#0f172a');
    group.appendChild(m3);

    const led1 = document.createElementNS(ns,'circle');
    led1.setAttribute('cx',-20);
    led1.setAttribute('cy',-4);
    led1.setAttribute('r',2.2);
    led1.setAttribute('fill','#22c55e');
    group.appendChild(led1);

    const led2 = document.createElementNS(ns,'circle');
    led2.setAttribute('cx',0);
    led2.setAttribute('cy',-4);
    led2.setAttribute('r',2.2);
    led2.setAttribute('fill','#22c55e');
    group.appendChild(led2);

    const led3 = document.createElementNS(ns,'circle');
    led3.setAttribute('cx',20);
    led3.setAttribute('cy',-4);
    led3.setAttribute('r',2.2);
    led3.setAttribute('fill','#ffd166');
    group.appendChild(led3);

    return;
  }

  if(node.type==='sensor'){
    const body = document.createElementNS(ns,'rect');
    body.setAttribute('x',-28);
    body.setAttribute('y',-16);
    body.setAttribute('width',56);
    body.setAttribute('height',32);
    body.setAttribute('rx',16);
    body.setAttribute('fill','#e5e7eb');
    body.setAttribute('stroke','#9ca3af');
    body.setAttribute('class','node-body');
    group.appendChild(body);

    const eye = document.createElementNS(ns,'ellipse');
    eye.setAttribute('cx',0);
    eye.setAttribute('cy',0);
    eye.setAttribute('rx',18);
    eye.setAttribute('ry',10);
    eye.setAttribute('fill','#111827');
    group.appendChild(eye);

    const pupil = document.createElementNS(ns,'circle');
    pupil.setAttribute('cx',0);
    pupil.setAttribute('cy',0);
    pupil.setAttribute('r',6);
    pupil.setAttribute('fill','#22c55e');
    group.appendChild(pupil);

    return;
  }

  if(node.type==='deception'){
    const body = document.createElementNS(ns,'rect');
    body.setAttribute('x',-34);
    body.setAttribute('y',-18);
    body.setAttribute('width',68);
    body.setAttribute('height',36);
    body.setAttribute('rx',10);
    body.setAttribute('fill','#ff6b35');
    body.setAttribute('stroke','#b45309');
    body.setAttribute('class','node-body');
    group.appendChild(body);

    const p1 = document.createElementNS(ns,'rect');
    p1.setAttribute('x',-28);
    p1.setAttribute('y',-12);
    p1.setAttribute('width',20);
    p1.setAttribute('height',10);
    p1.setAttribute('fill','#111827');
    p1.setAttribute('opacity','0.9');
    group.appendChild(p1);

    const p2 = document.createElementNS(ns,'rect');
    p2.setAttribute('x',-4);
    p2.setAttribute('y',-12);
    p2.setAttribute('width',20);
    p2.setAttribute('height',10);
    p2.setAttribute('fill','#111827');
    p2.setAttribute('opacity','0.9');
    group.appendChild(p2);

    const p3 = document.createElementNS(ns,'rect');
    p3.setAttribute('x',20);
    p3.setAttribute('y',-12);
    p3.setAttribute('width',14);
    p3.setAttribute('height',10);
    p3.setAttribute('fill','#111827');
    p3.setAttribute('opacity','0.9');
    group.appendChild(p3);

    const p4 = document.createElementNS(ns,'rect');
    p4.setAttribute('x',-28);
    p4.setAttribute('y',2);
    p4.setAttribute('width',20);
    p4.setAttribute('height',10);
    p4.setAttribute('fill','#020617');
    p4.setAttribute('opacity','0.9');
    group.appendChild(p4);

    const p5 = document.createElementNS(ns,'rect');
    p5.setAttribute('x',-4);
    p5.setAttribute('y',2);
    p5.setAttribute('width',20);
    p5.setAttribute('height',10);
    p5.setAttribute('fill','#020617');
    p5.setAttribute('opacity','0.9');
    group.appendChild(p5);

    const p6 = document.createElementNS(ns,'rect');
    p6.setAttribute('x',20);
    p6.setAttribute('y',2);
    p6.setAttribute('width',14);
    p6.setAttribute('height',10);
    p6.setAttribute('fill','#020617');
    p6.setAttribute('opacity','0.9');
    group.appendChild(p6);

    const logo = document.createElementNS(ns,'rect');
    logo.setAttribute('x',14);
    logo.setAttribute('y',8);
    logo.setAttribute('width',18);
    logo.setAttribute('height',10);
    logo.setAttribute('rx',3);
    logo.setAttribute('fill','#111827');
    logo.setAttribute('opacity','0.9');
    group.appendChild(logo);

    const t = document.createElementNS(ns,'text');
    t.setAttribute('x',23);
    t.setAttribute('y',16);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('fill','#facc15');
    t.setAttribute('font-size','7');
    t.setAttribute('font-weight','bold');
    t.textContent = 'DEC';
    group.appendChild(t);

    return;
  }

  if(node.type==='motor' || node.type==='actuator' || node.type==='piston' || node.type==='belt'){
    const rect = document.createElementNS(ns,'rect');
    rect.setAttribute('x',-18);
    rect.setAttribute('y',-12);
    rect.setAttribute('width',36);
    rect.setAttribute('height',24);
    rect.setAttribute('rx',4);
    rect.setAttribute('fill','#2f3e46');
    rect.setAttribute('stroke','#1b262c');
    rect.setAttribute('class','node-body');
    group.appendChild(rect);
    if(node.type==='motor'){
      const circle = document.createElementNS(ns,'circle');
      circle.setAttribute('cx',0);
      circle.setAttribute('cy',0);
      circle.setAttribute('r',7);
      circle.setAttribute('fill','#457b9d');
      group.appendChild(circle);
    }else if(node.type==='belt'){
      const belt = document.createElementNS(ns,'rect');
      belt.setAttribute('x',-16);
      belt.setAttribute('y',-4);
      belt.setAttribute('width',32);
      belt.setAttribute('height',8);
      belt.setAttribute('fill','#6c757d');
      group.appendChild(belt);
    }
    return;
  }

  const rect = document.createElementNS(ns,'rect');
  rect.setAttribute('x',-24);
  rect.setAttribute('y',-16);
  rect.setAttribute('width',48);
  rect.setAttribute('height',32);
  rect.setAttribute('rx',4);
  rect.setAttribute('fill','#6c757d');
  rect.setAttribute('stroke','#495057');
  rect.setAttribute('class','node-body');
  group.appendChild(rect);
}

function drawNode(svg,node){
  const ns = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(ns,'g');
  g.setAttribute('class','node-group');
  g.setAttribute('data-id',node.id);
  if(typeof node.y !== 'number'){
    node.y = getLayerCenterY(node.layer);
  }
  g.setAttribute('transform',`translate(${node.x},${node.y})`);

  drawNodeShape(g,node);

  const label = document.createElementNS(ns,'text');
  label.setAttribute('class','node-label');
  label.setAttribute('x',0);
  label.setAttribute('y',30);
  label.setAttribute('text-anchor','middle');
  label.textContent = node.name;
  g.appendChild(label);

  g.addEventListener('mouseenter',(e)=>{
    showNodeTooltip(e,node);
    highlightFromNode(node.id);
  });
  g.addEventListener('mousemove',updateTooltipPosition);
  g.addEventListener('mouseleave',()=>{
    hideTooltip();
    clearHighlight();
  });

  g.addEventListener('mousedown',(e)=>startDrag(e,node.id));

  svg.appendChild(g);
  node.group = g;
}

function getNodeAnchor(nodeId){
  const n = currentNodes[nodeId];
  return {x:n.x, y:n.y};
}

function buildLinkPath(from,to){
  const a = getNodeAnchor(from);
  const b = getNodeAnchor(to);
  const midY = (a.y + b.y)/2;
  return `M ${a.x} ${a.y} L ${a.x} ${midY} L ${b.x} ${midY} L ${b.x} ${b.y}`;
}

function drawLink(svg,link,index){
  const ns = 'http://www.w3.org/2000/svg';
  const path = document.createElementNS(ns,'path');
  path.setAttribute('d',buildLinkPath(link.from,link.to));
  path.setAttribute('class','link-path link-'+link.kind);
  path.setAttribute('data-index',index);

  const fromNode = currentNodes[link.from];
  const toNode   = currentNodes[link.to];
  let tipo = 'Conexi√≥n de datos';
  if(link.kind==='mgmt') tipo = 'Conexi√≥n de gesti√≥n';
  if(link.kind==='span') tipo = 'Conexi√≥n SPAN (copia de tr√°fico)';
  if(link.kind==='api')  tipo = 'Integraci√≥n v√≠a API';
  const desc = link.descExtra || '';
  const label = `${tipo}: ${fromNode.name} ‚Üî ${toNode.name}${desc ? ' ‚Äì '+desc : ''}`;

  path.addEventListener('mouseenter',(e)=>{
    showLineTooltip(e,label);
    highlightFromNode(link.from);
  });
  path.addEventListener('mousemove',updateTooltipPosition);
  path.addEventListener('mouseleave',()=>{
    hideTooltip();
    clearHighlight();
  });

  svg.appendChild(path);
  link.path = path;
}

function buildAdjacency(){
  adjacency = {};
  Object.keys(currentNodes).forEach(id=>{adjacency[id]=new Set();});
  currentLinks.forEach(l=>{
    if(adjacency[l.from]) adjacency[l.from].add(l.to);
    if(adjacency[l.to])   adjacency[l.to].add(l.from);
  });
}

function getDirectNeighbors(startId){
  const direct = new Set([startId]);
  (adjacency[startId] || []).forEach(n => direct.add(n));
  return direct;
}

function clearHighlight(){
  if(!currentSvg) return;
  const nodes = currentSvg.querySelectorAll('.node-group');
  const links = currentSvg.querySelectorAll('.link-path');
  nodes.forEach(n=>{
    n.classList.remove('dim-node','highlight-node');
  });
  links.forEach(l=>{
    l.classList.remove('dim-link','highlight-link');
  });
}

function highlightFromNode(nodeId){
  if(!currentSvg) return;
  const reachable = getDirectNeighbors(nodeId);
  const nodes = currentSvg.querySelectorAll('.node-group');
  const links = currentSvg.querySelectorAll('.link-path');

  nodes.forEach(n=>{
    const id = n.getAttribute('data-id');
    if(reachable.has(id)){
      n.classList.add('highlight-node');
      n.classList.remove('dim-node');
    }else{
      n.classList.add('dim-node');
      n.classList.remove('highlight-node');
    }
  });

  links.forEach(l=>{
    const idx = Number(l.getAttribute('data-index'));
    const link = currentLinks[idx];
    if(reachable.has(link.from) && reachable.has(link.to)){
      l.classList.add('highlight-link');
      l.classList.remove('dim-link');
    }else{
      l.classList.add('dim-link');
      l.classList.remove('highlight-link');
    }
  });
}

function showNodeTooltip(e,node){
  const tooltip = document.getElementById('tooltip');
  const layer = getLayerInfo(node.layer);
  const layerName = (layer && layer.label) ? layer.label : 'Internet / Nube';
  let brandInfo = '';
  if(node.brand){
    const brandKey = node.brand;
    const brandName = brandKey.charAt(0).toUpperCase() + brandKey.slice(1);
    brandInfo = `<div class="layer">Marca: ${brandName}</div>`;
  }
  tooltip.innerHTML = `
    <strong>${node.name}</strong>
    <div class="layer">${layerName}</div>
    ${brandInfo}
    <div class="description">${node.description||''}</div>
  `;
  tooltip.classList.add('active');
  updateTooltipPosition(e);
}

function showLineTooltip(e,text){
  const tooltip = document.getElementById('tooltip');
  tooltip.innerHTML = `
    <strong>Conexi√≥n representativa</strong>
    <div class="description">${text}</div>
  `;
  tooltip.classList.add('active');
  updateTooltipPosition(e);
}

function updateTooltipPosition(e){
  const tooltip = document.getElementById('tooltip');
  const offset = 15;
  tooltip.style.left = (e.clientX + offset)+'px';
  tooltip.style.top  = (e.clientY + offset)+'px';
}

function hideTooltip(){
  const tooltip = document.getElementById('tooltip');
  tooltip.classList.remove('active');
}

function startDrag(e,nodeId){
  e.preventDefault();
  if(!currentSvg) return;
  const node = currentNodes[nodeId];
  if(!node) return;
  dragState = {
    nodeId,
    startMouseX: e.clientX,
    startX: node.x
  };
  window.addEventListener('mousemove',onDragMove);
  window.addEventListener('mouseup',endDrag);
}

function onDragMove(e){
  if(!dragState) return;
  const node = currentNodes[dragState.nodeId];
  if(!node) return;
  const dx = e.clientX - dragState.startMouseX;
  const container = document.getElementById('diagram-container');
  const width = container ? (container.clientWidth || 1000) : 1000;
  let newX = dragState.startX + dx;
  const margin = 40;
  if(newX < margin) newX = margin;
  if(newX > width - margin) newX = width - margin;
  node.x = newX;
  updatePositions();
}

function endDrag(){
  if(!dragState) return;
  window.removeEventListener('mousemove',onDragMove);
  window.removeEventListener('mouseup',endDrag);
  dragState = null;
}

function updatePositions(){
  Object.values(currentNodes).forEach(node=>{
    if(node.group){
      node.group.setAttribute('transform',`translate(${node.x},${node.y})`);
    }
  });
  currentLinks.forEach(link=>{
    if(link.path){
      link.path.setAttribute('d',buildLinkPath(link.from,link.to));
    }
  });
}

/* Diagrama principal */
function updateDiagram(){
  const container = document.getElementById('diagram-container');
  if(!container) return;
  const width  = container.clientWidth || 1000;
  const height = purdueLayers.reduce((acc,l)=>acc+l.height,0);

  container.innerHTML = '';
  const svg = createSvg(width,height);
  currentSvg = svg;

  drawLayers(svg,width);

  const arch = buildArchitecture();
  currentNodes = arch.nodes;
  currentLinks = arch.links;

  currentLinks.forEach((link,idx)=>drawLink(svg,link,idx));
  Object.values(currentNodes).forEach(node=>drawNode(svg,node));

  placeSaaS(currentNodes);
  updatePositions();

  container.appendChild(svg);
  buildAdjacency();
}

/* Posicionar consolas SaaS en capa 5 */
function placeSaaS(nodes){
  if(!nodes) return;
  const allNodes = nodes;
  const saas = Object.values(allNodes).filter(n => n.type === 'cloud-console');
  if(saas.length === 0) return;

  const internet = allNodes['internet'];
  const centerX = internet ? internet.x : 430;
  const centerY5 = getLayerCenterY(5);

  const soc = saas.find(n => n.id === 'soc-console' || (n.name && n.name.toLowerCase().includes('soc')));
  const others = saas.filter(n => n !== soc);

  if(soc){
    soc.x = centerX;
    soc.y = centerY5 - 70;
  }

  let startX = centerX + 200;
  const step = 90;
  others.forEach((n,i)=>{
    n.x = startX + i*step;
    n.y = centerY5 + 10;
  });

  const remote = allNodes['remote-user'];
  if(remote){
    remote.x = centerX - 220;
    remote.y = centerY5;
  }
}

/* Mostrar/ocultar marcas */
function toggleBrands(solutionId){
  const checkbox = document.getElementById('sol-'+solutionId);
  const brandsGroup = document.getElementById('brands-'+solutionId);
  const radios = brandsGroup ? brandsGroup.querySelectorAll('input[type="radio"]') : [];
  if(checkbox.checked){
    if(brandsGroup) brandsGroup.classList.add('active');
    if(radios.length > 0){
      const anyChecked = Array.from(radios).some(r => r.checked);
      if(!anyChecked){
        radios[0].checked = true;
      }
    }
  }else{
    if(brandsGroup) brandsGroup.classList.remove('active');
    radios.forEach(r=>r.checked=false);
  }
  updateDiagram();
}

/* Init */
document.addEventListener('DOMContentLoaded',()=>{
  updateDiagram();
  toggleCostCenter();
  addAttendee('clientAttendeesList', true);
  addAttendee('internalAttendeesList', false);

  const coffeeBreak = document.getElementById('coffeeBreak');
  if(coffeeBreak){
    coffeeBreak.addEventListener('change', toggleCostCenter);
  }

  const addClient = document.getElementById('addClientAttendee');
  if(addClient){
    addClient.addEventListener('click',()=>addAttendee('clientAttendeesList', true));
  }
  const addInternal = document.getElementById('addInternalAttendee');
  if(addInternal){
    addInternal.addEventListener('click',()=>addAttendee('internalAttendeesList', false));
  }

  const toStep2 = document.getElementById('toStep2');
  if(toStep2){
    toStep2.addEventListener('click',()=>{
      if(validateStep1()){
        showStep('step-2');
      }else{
        alert('Por favor completa los campos obligatorios.');
      }
    });
  }
  const backToStep1 = document.getElementById('backToStep1');
  if(backToStep1){
    backToStep1.addEventListener('click',()=>showStep('step-1'));
  }
  const toStep3 = document.getElementById('toStep3');
  if(toStep3){
    toStep3.addEventListener('click',()=>showStep('step-3'));
  }
  const backToStep1FromSummary = document.getElementById('backToStep1FromSummary');
  if(backToStep1FromSummary){
    backToStep1FromSummary.addEventListener('click',()=>showStep('step-1'));
  }
  const backToStep2FromSummary = document.getElementById('backToStep2FromSummary');
  if(backToStep2FromSummary){
    backToStep2FromSummary.addEventListener('click',()=>showStep('step-2'));
  }
  const sendButton = document.getElementById('sendEmail');
  if(sendButton){
    sendButton.addEventListener('click', sendEmail);
  }

  const form = document.getElementById('reservationForm');
  if(form){
    form.addEventListener('change',updateDiagram);
  }
});
</script>
<script>
(() => {
  const ensureBadge = () => {
    let badge = document.getElementById('version-badge');
    if (!badge) {
      badge = document.createElement('div');
      badge.id = 'version-badge';
      document.body.insertBefore(badge, document.body.firstChild);
    }

    Object.assign(badge.style, {
      position: 'fixed',
      bottom: '10px',
      right: '10px',
      background: 'rgba(0, 0, 0, 0.6)',
      color: 'white',
      padding: '6px 12px',
      borderRadius: '6px',
      fontSize: '11px',
      zIndex: '9999',
    });

    return badge;
  };

  const badge = ensureBadge();
  const fallbackTitle = 'SHOT DEV (versi√≥n desconocida)';
  const fallbackBadge = 'DEV | versi√≥n no disponible';

  const applyVersionData = (data) => {
    const safeData = data && typeof data === 'object' ? data : {};
    const versionCandidate = safeData.version ?? safeData.semver ?? null;
    const version =
      typeof versionCandidate === 'string' || typeof versionCandidate === 'number'
        ? versionCandidate
        : null;

    const patching = safeData.patching && typeof safeData.patching === 'object' ? safeData.patching : {};
    const patchCounterRaw = patching.patchCounter;
    const lastPatchRaw = patching.lastPatch;

    const patchCounter =
      patchCounterRaw === 0 || patchCounterRaw
        ? patchCounterRaw
        : 'N/A';
    const lastPatch =
      typeof lastPatchRaw === 'string' || typeof lastPatchRaw === 'number'
        ? lastPatchRaw
        : 'N/A';

    document.title = version ? `SHOT DEV ${version}` : fallbackTitle;
    badge.textContent = version
      ? `DEV ${version} | Patch #${patchCounter} (${lastPatch})`
      : fallbackBadge;
  };

  fetch('../version.json')
    .then((response) => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then((data) => {
      applyVersionData(data);
    })
    .catch(() => {
      document.title = fallbackTitle;
      badge.textContent = fallbackBadge;
    });
})();
</script>

</body>
</html>
